---
title: "Thermolimit statistical analyses"
author: "Laura Segura Hernández"
date: "9/27/2022"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/laus1/OneDrive - University of Nebraska-Lincoln/UNL/PhD Tesis/Methods/Thermolimit/Thermolimit data analyses")
getwd()
```

#Libraries
```{r}
library(lme4)
library(dplyr)
library(forcats)
library(NRES803)
library(olsrr)
library(broom)
library(ggplot2)
library(lmerTest)
```
TO DO:

Organize code
Check for outliers in Topt data (after removing trial 2). I can Use the test I used for the TPC where I also removed some outliers




# Calling data

```{r}
dat<-read.csv("Outputs/ToptandRopts_trim.csv")

dat<-dat%>%
  mutate(stage=fct_relevel(stage, levels=c("Female", "Protonymph", "Deutonymph", "Tritonymph",  "Male"))) %>%
  arrange(stage) %>%
  mutate(date=fct_relevel(date, levels=c("2022-06-23", "2022-06-21", "2022-06-22", "2022-06-24"))) %>%
  arrange(date)

sample<-dat %>%
  group_by(stage) %>%
  summarize(n=n())
sample
```
# Exploring the data

## Checking the ramping rate accross trials
```{r}
ggplot(dat, aes(x=ramp, y=tempcorr, color=as.factor(trial)))+geom_point()

ggplot(dat, aes(y=ramp))+ geom_boxplot()



```


From the figure above seems like the ramping rate of trial 2 if much lower than that of other trials. That is just one trial (trial 2) and I think it would be better to just drop that trial since (1) I was aiming for a ramping rate of 0.25 C/min and by trial 2 I did not achieve a value close to it, and (2), it was just a trial, dropping it won't alter much of my sample size. I think it would be easier to just drop a trial than to justify its inclusion, especially since the heating rate can affect the values I got. 




## Removing trial 2
```{r}
dat2<-dat %>%
  filter(trial!=2)

sample2<-dat2 %>%
  group_by(stage) %>%
  summarize(n=n())
sample2


ggplot(dat2, aes(x=ramp, y=tempcorr, color=as.factor(trial)))+geom_point()

ggplot(dat2, aes(y=ramp))+ geom_boxplot()



```





# Comparing Topt: 

> Research question: Does the temperature optima differ between life stages?

## Plotting from the raw data

```{r}
averages<-dat2%>%
  group_by(stage) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n), median=median(tempcorr))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + 
  geom_point(aes(y = median),color = "red", size = 3, data = averages, position=position_nudge(x=0.2)) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot

```



## Checking for outliers
```{r}

#Comparing boxplots for all data vs separated by sex: points represent data values that alie outside 1.5xIQR (Inter Quartile Range or the ifference between the 75th and 25th quantiles)
## Temperature optima
### All data
ggplot(dat2, aes(y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")
#Possible outliers:

###Separated by stage
ggplot(dat2, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")


#Taking into account both graphs, I feel inclines to remove the hight point at 37(fem) and the high point at 40 (male)

#Looking at the data and checking if it is normal to be able to run some tests
## Temperature optima
ggplot(dat2, aes(x=(tempcorr))) + geom_histogram() + facet_wrap(~stage)
#Not very normal




#Data is not normal for all stages, so I will look at cook's distance
## Temperature optima
mod<-lm((tempcorr)~stage, data=dat2)
NRES803::check_assumptions(mod)
hist(residuals(mod, type="pearson"))
cooksd<-cooks.distance((mod)) #estimating cooks distance
csd<-as.data.frame(cooksd)
plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels

#Removing all influential points
influential <- as.numeric(names(cooksd)[(cooksd > (4*mean(cooksd)))]) #Identifying row number for the outliers. This selects the outliers that arelarger than 4 times the mean cooks distance value of all outliers
influential
#removing the top most influential points: 
top_x_outlier <- 5
# The first 5 outliers consist of: 270, 141 and 173 which are the outliers in the boxplots too, 35 is within the top 3 influential points and the curve was odd (had 4 peaks so I wasn't sure I picked the right one), and individual 43 has the highest cooks distance overall.
influential <- as.numeric(names(sort(cooksd, decreasing = TRUE)[1:top_x_outlier]))
influential

#Remocing outliers from data
dat2b<-dat2[-influential,]
out<-dat2[influential,]
out
out2<-csd[influential,]
out2
#Comparing boxplots to see what was removed
ggplot(dat2b, aes(x=stage, y=tempcorr)) + geom_boxplot(aes()) # 
ggplot(dat2b, aes( y=(tempcorr))) + geom_boxplot(aes()) # 
#The graph changed



```





## Checking sample sizes
```{r}
sample2<-dat2b %>%
  group_by(stage) %>%
  summarize(n=n())
sample2
```
## Exploring the new dataset: how do the different variables look in regards to Topt
### Date
```{r}
averages<-dat2b%>%
  group_by(date) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n), median=median(tempcorr))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat2b, aes(x = date))+ 
  geom_point(aes(y = tempcorr, color=as.factor(trial)), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=date, ymin = lwr3, ymax = upr3, group=date), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot
```

### Ramp
```{r}
# Plot with prediction trends, standard error and data
plot<-ggplot(dat2b, aes(x = ramp, y=tempcorr))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Thermal optima (Celsius)")
plot

plot<-ggplot(dat2b, aes(x = ramp, y=tempcorr))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+
  facet_wrap(~stage)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Thermal optima (Celsius)")
plot
```

### Stage

```{r}
averages<-dat2b%>%
  group_by(stage) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n), median=median(tempcorr))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat2b, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) +
geom_point(aes(y = median),color = "red", size = 3, data = averages, position=position_nudge(x=0.2))+ #plotting the median
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot

```

The plot above has the data for each life stage, the mean and standard error (in black) and the median values of Topt per life stage. It seems that there might not be a difference in Topt across life stages, but it needs to be tested. 

## Exploring different statistical models

### Using mixed model: ramp and date as random factors

#### Defining the model
```{r}
#Trying different structures for the random effects
## Allowing date to vary the intercept and the ramp to affect the slope and intercept
t1<-lmer(tempcorr~stage+(1|date)+(stage|ramp), data=dat2b, REML=FALSE)
## Allowing date to vary the intercept and the ramp to affect  intercept
t1b<-lmer(tempcorr~stage+(1|date)+(1|ramp), data=dat2b, REML=FALSE)
## Allowing date to vary the intercept and the ramp to affect the slope
t1c<-lmer(tempcorr~stage+(1|date)+(stage-1|ramp), data=dat2b, REML=FALSE)

#Comparing AIC values to see which structure of the random factors worked better
aic <- sapply(list(t1, t1b,t1c), AIC)
aic <- data.frame(Model = c("t1", "t1b", "t1c"), AIC = format(aic, digits = 5)) %>%
    arrange(AIC)
aic

#Seems like t1b has the best structure of the random effects

```
Seems like t1b has the best structure of the random effects

#### Doing backwards selection
```{r}
summary(t1b)

t1b2<-lmer(tempcorr~stage+(1|date)+(1|ramp), data=dat2b, REML=TRUE)

step(t1b2)

t1b3<-lmer(tempcorr~stage+(1|ramp), data=dat2b, REML=TRUE)

step(t1b3)
```
Seems like removing the date as a random factor is ok, as it is not contributing to explain the variance of the response. 

#### Checking assumptions
```{r}
ggplot(dat2b, aes(x=tempcorr))+geom_histogram()
shapiro.test(dat2b$tempcorr)

#checking assumptionss
rr <- broom.mixed::augment(t1b3)
ggplot(rr, aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth() +
    geom_hline(yintercept = 0, linetype = 2)
ggplot(rr, aes(x = .fitted, y = sqrt(abs(.resid)))) + geom_point() +
    geom_smooth() + geom_hline(yintercept = 0.822)

# get int and slope for qqline
probs <- c(0.25, 0.75)
y <- quantile(rr$.resid, probs, names = FALSE, na.rm = TRUE)
x <- qnorm(probs)
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]
ggplot(rr, aes(sample = .resid)) + geom_qq(size = rel(4)) + geom_abline(intercept = int,
    slope = slope, linetype = 2, size = 2)

ggplot(rr, aes(x = stage, y = .fitted, color=stage)) + geom_point()+geom_jitter()


```

Data seems fairly ok. Now I can look at the results:

#### Looking at the results
```{r}
summary (t1b3)

confint(t1b3)
coefTable <- summary(t1b3, ddf = "Kenward-Roger")$coefficients
coefTable


#nd<-data.frame(ramp=seq(0.24,0.26,0.005), date=c("2022-06-23"), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))

#class(t1b2) <- class(t1b)

#pred <- bind_cols(nd, tempcorr = predict(t1b2, newdata = nd,
#    re.form = NULL))
#ggplot(mice, aes(x = cfoot, y = cear)) + geom_point(alpha = 0.2) +
#    xlab("Foot Length deviations [mm]") + ylab("Ear Length deviations [mm]") +
#    geom_point(data = filter(mice, site == "42"), alpha = 1,
#        color = "red") + geom_line(data = pred42, size = 2, color = "red")



#days_coef <- fixef(t1b2)[2]

#tidy(t1b2,effects="fixed")
```

### Using mixed model: date as random factor and ramp as a fixed effect

#### Defining the model
```{r}
#Trying different structures for the random effects
## Allowing date to vary the intercept and the ramp to affect the slope and intercept
t1b3<-lmer(tempcorr~stage+(1|ramp), data=dat2b, REML=FALSE)
t2<-lmer(tempcorr~stage*ramp+(1|date), data=dat2b, REML=FALSE)


#Comparing AIC values to see which structure of the random factors worked better
aic <- sapply(list(t1, t1b,t1c, t2, t1b3), AIC)
aic <- data.frame(Model = c("t1", "t1b", "t1c", "t2", "t1b3"), AIC = format(aic, digits = 5)) %>%
    arrange(AIC)
aic

#Seems like t1b3 has the best structure of the random effects, but t2 is not too far behind

```
#### Doing backwards selection
```{r}
summary(t2)

t2b<-lmer(tempcorr~stage*ramp+(1|date), data=dat2b, REML=TRUE)

step(t2b)
```
Seems like I can't remove the interaction nor date as a random effect. So let's move on:


#### Checking assumptions
```{r}

#checking assumptionss
rr <- broom.mixed::augment(t2b)
ggplot(rr, aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth() +
    geom_hline(yintercept = 0, linetype = 2)
ggplot(rr, aes(x = .fitted, y = sqrt(abs(.resid)))) + geom_point() +
    geom_smooth() + geom_hline(yintercept = 0.822)

# get int and slope for qqline
probs <- c(0.25, 0.75)
y <- quantile(rr$.resid, probs, names = FALSE, na.rm = TRUE)
x <- qnorm(probs)
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]
ggplot(rr, aes(sample = .resid)) + geom_qq(size = rel(4)) + geom_abline(intercept = int,
    slope = slope, linetype = 2, size = 2)

ggplot(rr, aes(x = stage, y = .fitted, color=stage)) + geom_point()+geom_jitter()


```

#### Looking at the results
```{r}
summary(t2b)

coefTable <- summary(t2b, ddf = "Kenward-Roger")$coefficients
coefTable

# Predicting the rate
nd<-data.frame(ramp=seq(0.24,0.26,0.005), date=c("2022-06-23" ), stage=rep(c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), each=5))

class(t2b) <- class(t2)

pred <- bind_cols(nd, tempcorr = predict(t2, newdata = nd,
    re.form = NULL))

ggplot(dat2b, aes(x = ramp, y = tempcorr, color=stage)) + geom_point(alpha=0.2) +
    xlab("Ramping rate") + ylab("Thermal optima (Celsius)") +
  theme_classic()+ theme(text = element_text(size = 15))+ 
  geom_point(data = filter(dat2b, date == "2022-06-23"), alpha = 1) + 
  geom_line(data = pred, size = 2)

# Predicting at each rate
nd<-data.frame(ramp=0.24, date=c("2022-06-23" ), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
pred24 <- bind_cols(nd, tempcorr = predict(t2, newdata = nd,
    re.form = NULL))

nd<-data.frame(ramp=0.25, date=c("2022-06-23" ), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
pred25 <- bind_cols(nd, tempcorr = predict(t2, newdata = nd,
    re.form = NULL))

nd<-data.frame(ramp=0.26, date=c("2022-06-23" ), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
pred26 <- bind_cols(nd, tempcorr = predict(t2, newdata = nd,
    re.form = NULL))


ggplot(dat2b, aes(x =stage, y = tempcorr)) + geom_point(alpha=0.2) +
    xlab("Ramping rate") + ylab("Thermal optima (Celsius)") +
  theme_classic()+ theme(text = element_text(size = 15))+ 
  geom_point(data = filter(dat2b, date == "2022-06-23"), alpha = 1) + 
  geom_point(data = pred24, size = 3, color="#9ecae1", position=position_nudge(x=0.2))+
  geom_point(data = pred25, size = 3, color="#2171b5", position=position_nudge(x=0.2))+
  geom_point(data = pred26, size = 3, color="#08306b", position=position_nudge(x=0.2))




days_coef <- fixef(t1b2)[2]

tidy(t1b2,effects="fixed")
```

### Including both date and ramp as fixed factors in the model

```{r}
t1<-lm(tempcorr~stage+date+ramp+stage:ramp, data=dat2b)
summary(t1)
check_assumptions(t1) #it doesnt look too bad
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #Kolmogorov (more than n=50): data is normal
```

Data is normal (Kolmogorov Smirnoff is non-significant).

#### Bacwards selection
```{r}
drop1(t1, test="Chisq")





```

Seems like I can;t drop any of the factors of the model

#### Checking assumptions
```{r}
check_assumptions(t1)
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #data is  normal
# Still  normal
```

#### Looking at the results
```{r}
summary(t1)
# Making the plot
nd = expand.grid(ramp=seq(0.24,0.26,0.005), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-23")
predicted.t1 <- augment(t1, newdata = nd, se_fit=TRUE)
stats.t1<-glance(t1)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t1$df.residual)
predicted.t1$lwr <- with(predicted.t1, .fitted - tcrit * .se.fit)
predicted.t1$upr <- with(predicted.t1, .fitted + tcrit * .se.fit)

# Plot with just prediction trend
t1plot <- ggplot(dat2b, aes(x = ramp, y = tempcorr)) + 
  geom_line(aes(y = .fitted, group = stage, linetype = stage, color=stage),size=1.5, data = predicted.t1) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Thermal optima (Celsius)")+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3) 
t1plot



# Plot with prediction trends, confidence intervals and data
t1plot<-ggplot(dat2b, aes(x = ramp)) + 
  geom_line(aes(y = .fitted, color=stage, group=stage,linetype = stage), 
            data = predicted.t1, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=stage, fill=stage), 
              data = predicted.t1, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Thermal optima (Celsius)")+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3) 
t1plot

#ggsave(plot=last_plot(),filename="Topt_stage.jpg",  path="Outputs/Statistics/")
```
```{r}
summary(t1)
#Saving results in word doc
#sjPlot::tab_model(t4, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
#                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
#                  dv.labels = c("Activation energy per weight and date"), 
#                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Temp_stages.doc")

#With ramp=0.24
# Making the plot
nd = expand.grid(ramp=0.24, stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-23")
predicted.t1 <- augment(t1, newdata = nd, se_fit=TRUE)
stats.t1<-glance(t1)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t1$df.residual)
predicted.t1$lwr3 <- with(predicted.t1, .fitted -  .se.fit) #Using just the standard error
predicted.t1$upr3 <- with(predicted.t1, .fitted + .se.fit)


# Plot with prediction trends, standard error and data
t1plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t1,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.t1, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t1plot


#Con ramp=0.25
# Making the plot
nd = expand.grid(ramp=0.25, stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-23")
predicted.t1 <- augment(t1, newdata = nd, se_fit=TRUE)
stats.t1<-glance(t1)

predicted.t1$lwr3 <- with(predicted.t1, .fitted -  .se.fit) #Using just the standard error
predicted.t1$upr3 <- with(predicted.t1, .fitted + .se.fit)


# Plot with prediction trends, standard error and data
t1plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t1,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.t1, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t1plot

#Con ramp=0.26
# Making the plot
nd = expand.grid(ramp=0.26, stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-23")
predicted.t1 <- augment(t1, newdata = nd, se_fit=TRUE)
stats.t1<-glance(t1)

predicted.t1$lwr3 <- with(predicted.t1, .fitted -  .se.fit) #Using just the standard error
predicted.t1$upr3 <- with(predicted.t1, .fitted + .se.fit)


# Plot with prediction trends, standard error and data
t1plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t1,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.t1, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t1plot

#ggsave(plot=last_plot(),filename="Topt_stage.jpg",  path="Outputs/Statistics/")
```



### Comparing the medians
Since the medians are not affected by outliers, I can try doing this with both, the full dataset and the dataset withou outliers
```{r}
# With all points
kruskal.test(tempcorr~stage, data=dat2)
pairwise.wilcox.test(dat2$tempcorr, dat2$stage,
                 p.adjust.method = "BH")
#Without outliers
kruskal.test(tempcorr~stage, data=dat2b)
pairwise.wilcox.test(dat2b$tempcorr, dat2b$stage,
                 p.adjust.method = "BH")

```

> Thinking about the effect of ramping across stages:

The ramping rate refers to how fast the heating occurred during the trial. It means that, for example, at ramping 0.24 and minute 50, I would expect temperature 40, for example. But then at the same point in time with a ramping rate of 0.26, I would expect a temperature of 60 (for example, not the real value). **This means that, if what I observe is just that the pseudoscorpions are reaching a topt as a result of just exposure to the experiment (i.e. they reach it at around the same minute, independently of the ramping rate), I would expect the topt to increase with the ramping rate. This would be the case for Deutonymphs, Males and Females.** 

However, if this is not the case and the topt goes down with ramping rate (e.g. Protonymphs and Tritonymphs), it could mean that when it is slow, the body can acclimate and cope better, therefore, reach warmer temperatures. But if it goes too fast, the body might not acclimate as well and reach topt at lower temperatures than it would if acclimation was allowed. 

Now, **if the increase in ramping rate also increases topt (e.g. females), it might also be explained by a lag response: the enviroment is changing so fast, the body's response is too slow and it is still responding to a previous temperature rather than the temprature the environment is currently having (see Lighton & Turner 2004).** This would also be more likely to occur at bigger body sizes, as smaller bodies are more strongly coupled with the environmental temperature and lags are less likely to occur.  **Now, as this is the same prediction as with the time effect exposed above. if the time does not differ between ramping rates for females, then it might be a lagged response, or that they might be acclimating better than the other life stages. And discerning between the two would be tricky**  

If the Topt remains the same along ramping rates, I think that just means that the ramping rate is not really affecting Topt and I can be more confident that the Topt value I got is good. For this, I would need to see if the slope of the line differs from zero. Check this tutorial to see if I can get the confidence intervals for the slope https://bookdown.org/dereksonderegger/571/10-mixed-effects-models.html


## Exploring the effect of time on the ramp and temperature interaction

### Visualizing data
```{r}
plot<-ggplot(dat, aes(x = ramp, y=logtime))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+
  facet_wrap(~stage)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot

plot<-ggplot(dat2b, aes(x = ramp, y=logtime))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+
  facet_wrap(~stage)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot



```

Seems like removing trial 2 was a good call overall. Now, it seems like females are dying at around the same time and that might explain the changes in Topt observed with ramping (topt increases as ramping increases). Let's keep exploring this relationship and how it affects stages.


```{r}
averages<-dat2b%>%
  group_by(stage) %>%
  summarize(mean=mean(logtime), sd=sd(logtime), n=n(), sem=sd/sqrt(n), median=median(logtime))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat2b, aes(x = stage))+ 
  geom_point(aes(y =logtime, color=ramp), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) +
geom_point(aes(y = median),color = "red", size = 3, data = averages, position=position_nudge(x=0.2))+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Time (minutes)")
plot
```

Time at which they reached topt doesn't seems to vary much between stages. Let's verify this with a test:

### Testing if logtime varied between stages

```{r}
t1<-lm(logtime~stage+date+ramp+stage:ramp, data=dat2b)
summary(t1)
check_assumptions(t1) #it doesnt look too bad
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #Kolmogorov (more than n=50): data is normal
```

#### Backwards selection
```{r}
drop1(t1, test="Chisq")

t2 <- update(t1, .~. -date)
drop1(t2, test="Chisq")



```
#### Checkign assumptions
```{r}
check_assumptions(t2) #it doesnt look too bad
hist(t2$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t2) #Kolmogorov (more than n=50): data is normal

```

Data is normal and heterocedastic, lets see the results:

#### Results
```{r}
summary(t2)
```
Seems like the interaction between time and ramp differs between females, protonymphs and tritonymphs. Let's look at the same plot as before:

```{r}
plot<-ggplot(dat2b, aes(x = ramp, y=logtime))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+
  facet_wrap(~stage)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot
```

Seems like most lifestages follow the expected pattern: as ramping increase, you would expect the Ropt to be reached as lower times (faster). This is not the case for females and it might be why the interaction ramp:stage might be significant. For females, it seems like the two points at the end of the ramping might drive the curve to be flat. We can try removing them to see if the results change in any way: 

#### Trying removing the two points of the females
```{r}
dat3<-dat2b%>%
  filter(!ind %in% c(37,5))

plot<-ggplot(dat3, aes(x = ramp, y=logtime))+ 
  geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(aes(group = stage, color=stage), method = "lm", se = FALSE)+
  facet_wrap(~stage)+ 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot


t1<-lm(logtime~stage+date+ramp+stage:ramp, data=dat3)
summary(t1)
check_assumptions(t1) #it doesnt look too bad
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #Kolmogorov (more than n=50): data is normal



drop1(t1, test="Chisq")

t2 <- update(t1, .~. -stage:ramp)
drop1(t2, test="Chisq")
t3 <- update(t2, .~. -date)
drop1(t3, test="Chisq")

summary(t3)

plot<-ggplot(dat2b, aes(x = ramp, y=logtime))+ 
   geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(method = "lm", se = FALSE)+
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot

plot<-ggplot(dat3, aes(x = ramp, y=logtime))+ 
   geom_point(aes(color=stage), size = 3, shape=1, stroke=1.2)  +
  geom_smooth(method = "lm", se = FALSE)+
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Ramp")+
  ylab("Time (minutes)")
plot

```
When removing the points, the interaction is not longer significant, now I will see if those points I removed can be considered outliers

#### Checking for outliers
```{r}

#Comparing boxplots for all data vs separated by sex: points represent data values that alie outside 1.5xIQR (Inter Quartile Range or the ifference between the 75th and 25th quantiles)
## Temperature optima
### All data
ggplot(dat2, aes(y=logtime))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Time (min)")
#Possible outliers:

###Separated by stage
ggplot(dat2, aes(x=stage, y=logtime))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Time (min)")


#Taking into account both graphs, I feel inclines to remove the hight point at 37(fem) and the high point at 40 (male)

#Looking at the data and checking if it is normal to be able to run some tests
## Temperature optima
ggplot(dat2, aes(x=(logtime))) + geom_histogram() + facet_wrap(~stage)
ggplot(dat2, aes(x=(ramp))) + geom_histogram(binwidth = 0.005) + facet_wrap(~stage)

#Not very normal




#Data is not normal for all stages, so I will look at cook's distance
## Temperature optima
mod<-lm((logtime)~stage*ramp, data=dat2)
NRES803::check_assumptions(mod)
hist(residuals(mod, type="pearson"))
cooksd<-cooks.distance((mod)) #estimating cooks distance
csd<-as.data.frame(cooksd)
plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels

#Removing all influential points
influential <- as.numeric(names(cooksd)[(cooksd > (4*mean(cooksd)))]) #Identifying row number for the outliers. This selects the outliers that arelarger than 4 times the mean cooks distance value of all outliers
influential
#removing the top most influential points: 
#top_x_outlier <- 5
# The first 5 outliers consist of: 270, 141 and 173 which are the outliers in the boxplots too, 35 is within the top 3 influential points and the curve was odd (had 4 peaks so I wasn't sure I picked the right one), and individual 43 has the highest cooks distance overall.
#influential <- as.numeric(names(sort(cooksd, decreasing = TRUE)[1:top_x_outlier]))
#influential

#Removing outliers from data
#dat2b<-dat2[-influential,]
out<-dat2[influential,]
out



```
It seems like the points we removed were not outliers. Now, considering that: (1) My main interest is to compare if topt differ between stages, (2) I only have a couple of point per ramping rate, and  (3) that ramping rate is not varying much (0.246-0.259), I think it might be fair to just say "The ramping rate was 0.25 +/- SE" when reporting the methods and maybe have it as a random factor, but not pay much attention to the interaction, since I don't have a big enough sample size for sustaining it (only 2 obs per ramping value aprox), and it complicates the interpretation of my question. 

## Final model
```{r}
summary(t1b3)
```




























# Comparing Ropt
## Checking for outliers
```{r, eval=FALSE, echo=FALSE}

#Comparing boxplots for all data vs separated by sex: points represent data values that alie outside 1.5xIQR (Inter Quartile Range or the ifference between the 75th and 25th quantiles)

##Rate optima
### All data
ggplot(dat2, aes(y=ropt2))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Maximum rate of oxygen consumption")

### Separated by stage
ggplot(dat2, aes(x=stage, y=ropt2))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Maximum rate of oxygen consumption")


#Taking into account both graphs, I feel inclines to remove the hight point at 37(fem) and the high point at 40 (male)

# Creating log-transformation of corrected slopes
slopes4$logcorr<-log(slopes4$corrected*-1)
ggplot(slopes4, aes(x=temp, y=(logcorr*-1), shape=sex, color=sex))+geom_point()+geom_smooth(method=loess, se=F)+theme_classic()+geom_hline(yintercept=0, linetype=3) +
  scale_x_continuous(limits=c(10,45),breaks=c(10,15,20,25,30,35,37,39,40,41,45))


#Looking at the data and checking if it is normal to be able to run some tests

## Rate optima
ggplot(dat2, aes(x=(ropt2))) + geom_histogram() + facet_wrap(~stage)
# Some more enormal than others

### Checking with log-transforming the ropt
ggplot(dat2, aes(x=stage, y=(log(ropt2)))) + geom_boxplot() #  have high extreme values, and  has low extreme values




#Data is not normal for all stages, so I will look at cook's distance
mod<-lm((ropt2)~stage, data=dat2)
NRES803::check_assumptions(mod)
plot(mod)
hist(residuals(mod, type="pearson"))
cooksd<-cooks.distance((mod)) #estimating cooks distance
csd<-as.data.frame(cooksd)
plot(cooksd, pch="*", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = 4*mean(cooksd, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksd)+1, y=cooksd, labels=ifelse(cooksd>4*mean(cooksd, na.rm=T),names(cooksd),""), col="red")  # add labels

#Removing all influential points
influential <- as.numeric(names(cooksd)[(cooksd > (4*mean(cooksd)))]) #Identifying row number for the outliers
influential
#removing the top most influential points: this is better, removes the 3 from the boxplot
top_x_outlier <- 3
influential <- as.numeric(names(sort(cooksd, decreasing = TRUE)[1:top_x_outlier]))

dat2b<-dat2[-influential,]
out<-dat2[influential,]
#slopes5<-slopes4[-105,] # the only point that is reported as highly influential by both the transformed and not transformed data
#Comparing boxplots to see what was removed
ggplot(dat2, aes(x=stage, y=ropt2)) + geom_boxplot(aes()) # 37, 40 and 41 have high extreme values, and 38 has low extreme values
ggplot(dat2, aes( y=(ropt2))) + geom_boxplot(aes()) # Females: high at 37. Males: high at 36, high and low at 39, 40
#The graph changed



```



# ############################################## * ###########################

# Using all trials

# Comparing Topt

## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
t1<-lm(tempcorr~stage+date+weight+ramp+stage:ramp, data=dat)
summary(t1)
check_assumptions(t1) #it doesnt look too bad
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #Kolmogorov (more than n=50): data is normal
```


### Backwards selection of global model
```{r, eval=FALSE, echo=FALSE}
## For now, I will use the model with the normal distribution and do backwards selection, later I will try a different distribution to see if the fit improves
# Doing backwards selection
drop1(t1, test="Chisq")

t2 <- update(t1, .~. -date)
drop1(t2, test="Chisq")

t3 <- update(t2, .~. -weight)
drop1(t3, test="Chisq")
```

It seems like the model with just ramp:stage is the best model. Now I will look to see if it meets the assumptions

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(t3)
hist(t3$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t3) #data is  normal
# Still  normal
```

### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(t3)
# Making the plot
nd = expand.grid(ramp=seq(0.2,0.26,0.005), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
predicted.t3 <- augment(t3, newdata = nd, se_fit=TRUE)
stats.t3<-glance(t3)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t3$df.residual)
predicted.t3$lwr <- with(predicted.t3, .fitted - tcrit * .se.fit)
predicted.t3$upr <- with(predicted.t3, .fitted + tcrit * .se.fit)

# Plot with just prediction trend
t3plot <- ggplot(dat, aes(x = ramp, y = tempcorr)) + 
  geom_line(aes(y = .fitted, group = stage, linetype = stage, color=stage),size=1.5, data = predicted.t3) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Thermal optima (Celsius)")
t3plot



# Plot with prediction trends, confidence intervals and data
t3plot<-ggplot(dat, aes(x = ramp)) + 
  geom_line(aes(y = .fitted, color=stage, group=stage,linetype = stage), 
            data = predicted.t3, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=stage, fill=stage), 
              data = predicted.t3, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Thermal optima (Celsius)")+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3) 
t3plot

ggsave(plot=last_plot(),filename="Topt_stage.jpg",  path="Outputs/Statistics/")
```


### Trying out using a random effect
```{r, eval=FALSE, echo=FALSE}
# Since I know the ramp is having an interaction with the stage, I will try to control for it as a random factor, since I am not really interested in testing for that?

# Trying out with a random effects
t4<-lmer(tempcorr~stage+date+weight+(stage|ramp), data=dat, REML=FALSE)
summary(t4)

#Checking assumptions
rr <- broom.mixed::augment(t4)
ggplot(rr, aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth() +
    geom_hline(yintercept = 0, linetype = 2)

# get int and slope for qqline
probs <- c(0.25, 0.75)
y <- quantile(rr$.resid, probs, names = FALSE, na.rm = TRUE)
x <- qnorm(probs)
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]
ggplot(rr, aes(sample = .resid)) + geom_qq(size = rel(4)) + geom_abline(intercept = int,
    slope = slope, linetype = 2, size = 2)

ggplot(rr, aes(x = .fitted, y = sqrt(abs(.resid)))) + geom_point() +
    geom_smooth() + geom_hline(yintercept = 0.822)

#Geeting the coefficients for each group taking into account the random effects
#t4summ<-knitr::kable(cbind(ranef(t4)$stage, coef(t4)$stage))

t4<-lmer(tempcorr~stage+date+weight+(stage|ramp), data=dat)
coefTable <- summary(t4, ddf = "Kenward-Roger")$coefficients
coefTable

#Backwards selection
step(t4, ddf = "Satterthwaite")

t5<-lmer(tempcorr~stage+(stage|ramp), data=dat)
summary(t5)
coefTable <- summary(t5, ddf = "Kenward-Roger")$coefficients
coefTable

#Checking assumptions
rr <- broom.mixed::augment(t5)
ggplot(rr, aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth() +
    geom_hline(yintercept = 0, linetype = 2)

# get int and slope for qqline
probs <- c(0.25, 0.75)
y <- quantile(rr$.resid, probs, names = FALSE, na.rm = TRUE)
x <- qnorm(probs)
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]
ggplot(rr, aes(sample = .resid)) + geom_qq(size = rel(4)) + geom_abline(intercept = int,
    slope = slope, linetype = 2, size = 2)

ggplot(rr, aes(x = .fitted, y = sqrt(abs(.resid)))) + geom_point() +
    geom_smooth() + geom_hline(yintercept = 0.822)

```

I am not convinced the random effect helped. However, since stage and weight might be correlated (e.g. deutonymphs and protonymps are alwasys smaller than adults), and since weight becomes relevant in other models, I will test replacing stage for weight to keep all models consistent. 

## Looking at weight

### Global model
```{r, eval=FALSE, echo=FALSE}
t6<-lm(tempcorr~stage+date+weight+ramp+weight:ramp, data=dat)
summary(t6)
check_assumptions(t6) #it doesnt look too bad
hist(t6$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t6) #Kolmogorov (more than n=50): data is normal
```


### Backwards selection for weight
```{r, eval=FALSE, echo=FALSE}
drop1(t6, test="Chisq")

t7 <- update(t6, .~. -date)
drop1(t7, test="Chisq")

t8 <- update(t7, .~. -stage)
drop1(t8, test="Chisq")

```

It seems like the model with just ramp:weight is the best model. Now I will look to see if it meets the assumptions

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(t8)
hist(t8$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t8) #data is  normal
```

### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(t8)
# Making the plot
nd = expand.grid(ramp=seq(0.20,0.26,0.005), weight=c(0.1, 1.1, 2.3))
predicted.t8 <- augment(t8, newdata = nd, se_fit=TRUE)
stats.t8<-glance(t8)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t8$df.residual)
predicted.t8$lwr <- with(predicted.t8, .fitted - tcrit * .se.fit)
predicted.t8$upr <- with(predicted.t8, .fitted + tcrit * .se.fit)


# Plot with just prediction trends
#t8plot <- ggplot(dat, aes(x = ramp, y = tempcorr)) + 
#  geom_line(aes(y = .fitted, group = as.factor(weight), linetype = as.factor(weight), color=weight),size=1.5, data = predicted.t8)  + theme_classic()+ theme(text = #element_text(size = 15))+ 
#  xlab("Heat ramping rate (Celsius/minute)")+
#  ylab("Thermal optima (Celsius)")
#t8plot

# Plot with prediction trends, confidence intervals and data
t8plot<-ggplot(dat, aes(x = ramp))  + 
  geom_line(aes(y = .fitted, color=weight, group=as.factor(weight),linetype = as.factor(weight)), 
            data = predicted.t8, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=as.factor(weight), fill=weight), 
              data = predicted.t8, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Thermal optima (Celsius)")+ 
  geom_point(aes(y = tempcorr, color=weight), size = 3) + scale_color_gradient(low="#9ecae1", high="#08306b") + scale_fill_gradient(low="#9ecae1", high="#08306b")
t8plot
ggsave(plot=last_plot(),filename="Topt_weight.jpg",  path="Outputs/Statistics/")



```


# Comparing Ropt

## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
r1<-lm(ropt2~stage+date+weight+ramp+stage:ramp, data=dat)
summary(r1)
check_assumptions(r1)
hist(r1$residuals, main = "Residual Histogram")
ols_test_normality(r1) #Kolmogorov: data is normal
```


### Backwards selection

```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(r1, test="Chisq")

r2 <- update(r1, .~. -stage:ramp)
drop1(r2, test="Chisq")

r3 <- update(r2, .~. -weight)
drop1(r3, test="Chisq")

r4 <- update(r3, .~. -date)
drop1(r4, test="Chisq")
```

### Checking assumptions

```{r, eval=FALSE, echo=FALSE}
check_assumptions(r4)
hist(r4$residuals, main = "Residual Histogram")
ols_test_normality(r4) #Kolmogorov: data is normal
```

### Summary and result plots
```{r, eval=FALSE, echo=FALSE}
summary(r4)

# Making the plot
nd = expand.grid(ramp=seq(0.2,0.26,0.005), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
predicted.r4 <- augment(r4, newdata = nd, se_fit=TRUE)
stats.r4<-glance(r4)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.r4$df.residual)
predicted.r4$lwr <- with(predicted.r4, .fitted - tcrit * .se.fit)
predicted.r4$upr <- with(predicted.r4, .fitted + tcrit * .se.fit)



# Plot with prediction trends
r4plot <- ggplot(dat, aes(x = ramp, y = ropt2)) + 
  geom_line(aes(y = .fitted, group = stage, linetype = stage, color=stage),size=1.5, data = predicted.r4) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))")
r4plot

# Plot with prediction trends, confidence intervals and data
r4plot<-ggplot(dat, aes(x = ramp)) + 
  geom_line(aes(y = .fitted, color=stage, group=stage,linetype = stage), 
            data = predicted.r4, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=stage, fill=stage), 
              data = predicted.r4, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))")+ 
  geom_point(aes(y = ropt2, color=stage), size = 3) 
r4plot



ggsave(plot=last_plot(),filename="Ropt_stage.jpg",  path="Outputs/Statistics/")

```
## Looking at weight

### Global model

```{r, eval=FALSE, echo=FALSE}
r5<-lm(ropt2~stage+date+weight+ramp+weight:ramp, data=dat)
summary(r5)
check_assumptions(r5)
hist(r5$residuals, main = "Residual Histogram")
ols_test_normality(r5) #Kolmogorov: data is normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
drop1(r5, test="Chisq")

r6 <- update(r5, .~. -weight:ramp)
drop1(r6, test="Chisq")

r7 <- update(r6, .~. -stage)
drop1(r7, test="Chisq")

r8 <- update(r7, .~. -date)
drop1(r8, test="Chisq")
```


### Checking assumptions

```{r, eval=FALSE, echo=FALSE}
check_assumptions(r8)
hist(r8$residuals, main = "Residual Histogram")
ols_test_normality(r8) #Kolmogorov: data is normal
```

### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(r8)
# Making the plot
nd = expand.grid(ramp=seq(0.2,0.26,0.005), weight=c(0.1, 1.1, 2.3))
predicted.r8 <- augment(r8, newdata = nd, se_fit=TRUE)
stats.r8<-glance(r8)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.r8$df.residual)
predicted.r8$lwr <- with(predicted.r8, .fitted - tcrit * .se.fit)
predicted.r8$upr <- with(predicted.r8, .fitted + tcrit * .se.fit)



# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
r8plot <- ggplot(dat, aes(x = ramp, y = ropt2)) + 
  geom_line(aes(y = .fitted, group = as.factor(weight), linetype = as.factor(weight), color=weight),size=1.5, data = predicted.r8)+ theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))")
r8plot


# Plot with prediction trends, confidence intervals and data
r8plot<-ggplot(dat, aes(x = ramp))+ 
  geom_line(aes(y = .fitted, color=weight, group=as.factor(weight),linetype = as.factor(weight)), 
            data = predicted.r8, size = 2)+#scale_color_continuous(trans = 'reverse') + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=as.factor(weight), fill=weight), 
              data = predicted.r8, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+#scale_color_continuous(trans = 'reverse')+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))") + 
  geom_point(aes(y = ropt2, color=weight), size = 3)+ scale_color_gradient(low="#9ecae1", high="#08306b")+ scale_fill_gradient(low="#9ecae1", high="#08306b")
r8plot





ggsave(plot=last_plot(),filename="Ropt_weight.jpg",  path="Outputs/Statistics/")



```


# Comparing Activation energy

## Getting the data

```{r, eval=FALSE, echo=FALSE}
energy<-read.csv("Outputs/activation energy final.csv")
energy<-energy%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male" ))) %>%
  arrange(stage) %>%
  mutate(slope=slope*-1)
```

## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
e1<-lm(slope~stage+date+weight+ramp+stage:ramp, data=energy)
summary(e1)
check_assumptions(e1)
hist(e1$residuals, main = "Residual Histogram")
ols_test_normality(e1) #Kolmogorov: data is  normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(e1, test="Chisq")

e2 <- update(e1, .~. -weight)
drop1(e2, test="Chisq")
```

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(e2)
hist(e2$residuals, main = "Residual Histogram")
ols_test_normality(e2) #Kolmogorov: data is  normal
```


### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(e2)
# Making the plot for ramp*stage
nd = expand.grid(ramp=seq(0.2,0.25,0.005), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-21")
predicted.e2 <- augment(e2, newdata = nd)

# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
e2plot <- ggplot(energy, aes(x = ramp, y = slope)) + 
  geom_line(aes(y = .fitted, group = stage, linetype = stage, color=stage),size=1.5, data = predicted.e2)+ theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Activation energy")
e2plot
ggsave(plot=last_plot(),filename="Energy_stage.jpg",  path="Outputs/Statistics/")



# Making the plot for date
nd = expand.grid(ramp=0.225, stage=c("Protonymph"), date=factor(levels(as.factor(energy$date))))
predicted.e2 <- augment(e2, newdata = nd)

# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
e2plot2 <- ggplot(energy, aes(x = date, y = slope)) + 
  geom_point(aes(y = .fitted), data = predicted.e2)+ylab("Äctivation energy") + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Date")+
  ylab("Activation energy")
e2plot2 
ggsave(plot=last_plot(),filename="Energy_stage_weight.jpg",  path="Outputs/Statistics/")


```

## Looking at weight

### Global model
```{r, eval=FALSE, echo=FALSE}
e3<-lm(slope~stage+date+weight+ramp+weight:ramp, data=energy)
summary(e3)
check_assumptions(e3)
hist(e3$residuals, main = "Residual Histogram")
ols_test_normality(e3) #Kolmogorov: data is  NOT normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(e3, test="Chisq")

e4 <- update(e3, .~. -stage)
drop1(e4, test="Chisq")
```

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(e4)
hist(e4$residuals, main = "Residual Histogram")
ols_test_normality(e4) #Kolmogorov: data is  normal
```


### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(e4)
# Making the plot for ramp*stage
nd = expand.grid(ramp=seq(0.2,0.25,0.005),  weight=c(0.1, 1.1, 2.3), date="2022-06-21")
predicted.e4 <- augment(e4, newdata = nd)

# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
e4plot <- ggplot(energy, aes(x = ramp, y = slope)) + 
  geom_line(aes(y = .fitted, group = as.factor(weight), linetype = as.factor(weight), color=weight),size=1.5, data = predicted.e4)  + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Activation energy") + scale_color_gradient(low="#9ecae1", high="#08306b")
e4plot
ggsave(plot=last_plot(),filename="Energy_weight.jpg",  path="Outputs/Statistics/")

# Making the plot for date
ndb = expand.grid(ramp=0.225, weight=1.1, date=factor(levels(as.factor(energy$date))))
predicted.e4b <- augment(e4, newdata = ndb)

# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
e4plot2 <- ggplot(energy, aes(x = date, y = slope)) + 
  geom_point(aes(y = .fitted), data = predicted.e4b)+ylab("Äctivation energy") + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Date")+
  ylab("Activation energy")
e4plot2 
ggsave(plot=last_plot(),filename="Energy_weight_date.jpg",  path="Outputs/Statistics/")

```


# Dropping trial 2

Turns out trial 2 was the only one with a ramp below 0.24. Lets see if dropping it changes anything
```{r, eval=FALSE, echo=FALSE}
dat2<-dat%>%filter(trial!=2)

sample2<-dat2 %>%
  group_by(stage) %>%
  summarize(n=n())
sample2
```



# Comparing Topt

## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
t1<-lm(tempcorr~stage+date+weight+ramp+stage:ramp, data=dat2)
summary(t1)
check_assumptions(t1) #it doesnt look too bad
hist(t1$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t1) #Kolmogorov (more than n=50): data is normal
```
# Bacwards selection
```{r, eval=FALSE, echo=FALSE}
drop1(t1, test="Chisq")

t2 <- update(t1, .~. -weight)
drop1(t2, test="Chisq")

t3 <- update(t2, .~. -date)
drop1(t3, test="Chisq")

t4 <- update(t3, .~. -stage:ramp)
drop1(t4, test="Chisq")

t5 <- update(t4, .~. -ramp)
drop1(t5, test="Chisq")





t2 <- update(t1, .~. -stage:ramp)
drop1(t2, test="Chisq")

t3 <- update(t2, .~. -weight)
drop1(t3, test="Chisq")

t4 <- update(t3, .~. -date)
drop1(t4, test="Chisq")

t5 <- update(t4, .~. -ramp)
drop1(t5, test="Chisq")


```

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(t5)
hist(t5$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t5) #data is  normal
# Still  normal
```
### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(t5)
sjPlot::tab_model(t5, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Activation energy per weight and date"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Temp_stages.doc")


# Making the plot
nd = expand.grid(stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
predicted.t5 <- augment(t5, newdata = nd, se_fit=TRUE)
stats.t5<-glance(t5)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t5$df.residual)
predicted.t5$lwr <- with(predicted.t5, .fitted - tcrit * .se.fit) # 95% confidence interval as estimated when doing the continuous line
predicted.t5$upr <- with(predicted.t5, .fitted + tcrit * .se.fit)
predicted.t5$lwr2 <- with(predicted.t5, .fitted - 1.96 * .se.fit)# 95% confidence interval as estimated when doing the vcategorical variables in Drew's class
predicted.t5$upr2 <- with(predicted.t5, .fitted + 1.96 * .se.fit)
predicted.t5$lwr3 <- with(predicted.t5, .fitted -  .se.fit) #Using just the standard error
predicted.t5$upr3 <- with(predicted.t5, .fitted + .se.fit)


# Plot with prediction trends, confidence intervals and data
t5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t5, position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr, ymax = upr, group=stage), color = "black", data = predicted.t5, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t5plot

# Plot with prediction trends, confidence interval 2 and data
t5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t5, position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr2, ymax = upr2, group=stage), color = "black", data = predicted.t5, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t5plot

# Plot with prediction trends, standard error and data
t5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.t5,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.t5, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t5plot


# check Chads code
ggplot(dat2, aes(x=stage, y=tempcorr, color=stage))+
  geom_point(shape=1, size=3, stroke=1.2)+
  scale_fill_brewer(palette="Set1")+
  stat_summary(geom="point", fun=mean, size=3, color="black", position=position_nudge(x=0.2))+
  stat_summary(geom="errorbar", fun.data=mean_se, width=0.1, position=position_nudge(x=0.2), color="black")+
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")









ggsave(plot=last_plot(),filename="Topt_stage_minustrial2.jpg",  path="Outputs/Statistics/")
```


## Plotting from the raw data

```{r, eval=FALSE, echo=FALSE}
averages<-dat2%>%
  group_by(stage) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
t5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
t5plot

```


## Looking at weight

### Global model
```{r, eval=FALSE, echo=FALSE}
t6<-lm(tempcorr~date+weight+ramp+weight:ramp, data=dat2)
summary(t6)
check_assumptions(t6) #it doesnt look too bad
hist(t6$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t6) #Kolmogorov (more than n=50): data is normal
```


### Backwards selection for weight
```{r, eval=FALSE, echo=FALSE}
drop1(t6, test="Chisq")

t7 <- update(t6, .~. -date)
drop1(t7, test="Chisq")

t8 <- update(t7, .~. -weight:ramp)
drop1(t8, test="Chisq")

t9<- update(t8, .~. -ramp)
drop1(t9, test="Chisq")


```

It seems like the model with just ramp:weight is the best model. Now I will look to see if it meets the assumptions

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(t9)
hist(t9$residuals, main = "Residual Histogram") #it doesnt look too bad
ols_test_normality(t9) #data is  normal
```


### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
meanweight <- dat2 %>%
  group_by(stage) %>%
  summarize(mean=mean(weight), sd=sd(weight), n=n(), sem=sd/sqrt(n))
round(meanweight$mean,digits=2)


summary(t9)
sjPlot::tab_model(t9, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Activation energy per weight and date"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Temp_weight.doc")

# Making the plot
nd = expand.grid(weight=seq(0.1,2.2,0.05))
predicted.t9 <- augment(t9, newdata = nd, se_fit=TRUE)
stats.t9<-glance(t9)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.t9$df.residual)
predicted.t9$lwr <- with(predicted.t9, .fitted - tcrit * .se.fit)
predicted.t9$upr <- with(predicted.t9, .fitted + tcrit * .se.fit)


# Plot with just prediction trends
#t9plot <- ggplot(dat, aes(x = ramp, y = tempcorr)) + 
#  geom_line(aes(y = .fitted, group = as.factor(weight), linetype = as.factor(weight), color=weight),size=1.5, data = predicted.t9)  + theme_classic()+ theme(text = #element_text(size = 15))+ 
#  xlab("Heat ramping rate (Celsius/minute)")+
#  ylab("Thermal optima (Celsius)")
#t9plot

# Plot with prediction trends, confidence intervals and data
t9plot<-ggplot(dat2, aes(x = weight))+ 
  geom_point(aes(y = tempcorr, color=weight), size = 3) + scale_color_gradient(low="#9ecae1", high="#08306b")  + 
  geom_line(aes(y = .fitted), data = predicted.t9, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), data = predicted.t9, alpha = 0.5) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Weight (mg)")+
  ylab("Thermal optima (Celsius)")
t9plot
ggsave(plot=last_plot(),filename="Topt_weight_minustrial2.jpg",  path="Outputs/Statistics/")


# Plot with prediction trends, confidence intervals and data
t9plot<-ggplot(dat2, aes(x = weight))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3) + #scale_color_gradient(low="#9ecae1", high="#08306b")  + 
  geom_line(aes(y = .fitted), data = predicted.t9, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), data = predicted.t9, alpha = 0.5) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Weight (mg)")+
  ylab("Thermal optima (Celsius)")
t9plot

ggsave(plot=last_plot(),filename="Topt_weight_perstage_minustrial2.jpg",  path="Outputs/Statistics/")



```



# Comparing Ropt

## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
r1<-lm(ropt2~stage+date+weight+ramp+stage:ramp, data=dat2)
summary(r1)
check_assumptions(r1)
hist(r1$residuals, main = "Residual Histogram")
ols_test_normality(r1) #Kolmogorov: data is normal
```


### Backwards selection

```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(r1, test="Chisq")

r2 <- update(r1, .~. -stage:ramp)
drop1(r2, test="Chisq")

r3 <- update(r2, .~. -date)
drop1(r3, test="Chisq")

r4 <- update(r3, .~. -weight)
drop1(r4, test="Chisq")

r5 <- update(r4, .~. -ramp)
drop1(r5, test="Chisq")


```

### Checking assumptions

```{r, eval=FALSE, echo=FALSE}
check_assumptions(r5)
hist(r5$residuals, main = "Residual Histogram")
ols_test_normality(r5) #Kolmogorov: data is normal
```



### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(r5)
sjPlot::tab_model(r5, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Rate optima per stage"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Rate_stage.doc")


# Making the plot
nd = expand.grid(stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"))
predicted.r5 <- augment(r5, newdata = nd, se_fit=TRUE)
stats.r5<-glance(r5)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.r5$df.residual)
predicted.r5$lwr <- with(predicted.r5, .fitted - tcrit * .se.fit) # 95% confidence interval as estimated when doing the continuous line
predicted.r5$upr <- with(predicted.r5, .fitted + tcrit * .se.fit)
predicted.r5$lwr2 <- with(predicted.r5, .fitted - 1.96 * .se.fit)# 95% confidence interval as estimated when doing the vcategorical variables in Drew's class
predicted.r5$upr2 <- with(predicted.r5, .fitted + 1.96 * .se.fit)
predicted.r5$lwr3 <- with(predicted.r5, .fitted -  .se.fit) #Using just the standard error
predicted.r5$upr3 <- with(predicted.r5, .fitted + .se.fit)


# Plot with prediction trends, confidence intervals and data
r5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = ropt2, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.r5,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr, ymax = upr, group=stage), color = "black", data = predicted.r5, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
r5plot

# Plot with prediction trends, confidence interval 2 and data
r5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = ropt2, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.r5,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr2, ymax = upr2, group=stage), color = "black", data = predicted.r5, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
r5plot

# Plot with prediction trends, standard error and data
r5plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = ropt2, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.r5,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.r5, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
r5plot


# check Chads code
ggplot(dat2, aes(x=stage, y=ropt2, color=stage))+
  geom_point(shape=1, size=3, stroke=1.2)+
  scale_fill_brewer(palette="Set1")+
  stat_summary(geom="point", fun=mean, size=3, color="black", position=position_nudge(x=0.1))+
  stat_summary(geom="errorbar", fun.data=mean_se, width=0.1, position=position_nudge(x=0.1), color="black")+
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")









ggsave(plot=last_plot(),filename="Ropt_stage_minustrial2.jpg",  path="Outputs/Statistics/")
```


## Looking at weight

### Global model

```{r, eval=FALSE, echo=FALSE}
r6<-lm(ropt2~stage+date+weight+ramp+weight:ramp, data=dat2)
summary(r6)
check_assumptions(r6)
hist(r6$residuals, main = "Residual Histogram")
ols_test_normality(r6) #Kolmogorov: data is normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
drop1(r6, test="Chisq")

r7 <- update(r6, .~. -weight:ramp)
drop1(r7, test="Chisq")

r8 <- update(r7, .~. -stage)
drop1(r8, test="Chisq")

r9 <- update(r8, .~. -date)
drop1(r9, test="Chisq")

r10 <- update(r9, .~. -ramp)
drop1(r10, test="Chisq")

```


### Checking assumptions

```{r, eval=FALSE, echo=FALSE}
check_assumptions(r10)
hist(r10$residuals, main = "Residual Histogram")
ols_test_normality(r10) #Kolmogorov: data is normal
```

### Summary and result plots

```{r, eval=FALSE, echo=FALSE}

summary(r10)
sjPlot::tab_model(r10, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Rate optima per weight"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Rate_weight.doc")


# Making the plot
nd = expand.grid(weight=seq(0.1,2.2,0.05))
predicted.r10 <- augment(r10, newdata = nd, se_fit=TRUE)
stats.r10<-glance(r10)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.r10$df.residual)
predicted.r10$lwr <- with(predicted.r10, .fitted - tcrit * .se.fit)
predicted.r10$upr <- with(predicted.r10, .fitted + tcrit * .se.fit)


# Plot with prediction trends, confidence intervals and data
r10plot<-ggplot(dat2, aes(x = weight))+ 
  geom_point(aes(y = ropt2, color=weight), size = 3) + scale_color_gradient(low="#9ecae1", high="#08306b")  + 
  geom_line(aes(y = .fitted), data = predicted.r10, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), data = predicted.r10, alpha = 0.5) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Weight (mg)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))")
r10plot
ggsave(plot=last_plot(),filename="Ropt_weight_minustrial2.jpg",  path="Outputs/Statistics/")

r10plot<-ggplot(dat2, aes(x = weight))+ 
  geom_point(aes(y = ropt2, color=stage), size = 3) + #scale_color_gradient(low="#9ecae1", high="#08306b")  + 
  geom_line(aes(y = .fitted), data = predicted.r10, size = 2) + 
  geom_ribbon(aes(ymin = lwr, ymax = upr), data = predicted.r10, alpha = 0.5) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Weight (mg)")+
  ylab("Rate optima (Oxygen (mg/L) / time (min))")
r10plot
ggsave(plot=last_plot(),filename="Ropt_weight_perstage_minustrial2.jpg",  path="Outputs/Statistics/")


```


# Activation energy

## Dropping trial 2

```{r, eval=FALSE, echo=FALSE}
energy2<-energy %>%
  filter(trial!=2, trial !=3)
```



## Looking at stage

### Global model
```{r, eval=FALSE, echo=FALSE}
e1<-lm(slope~stage+date+weight+ramp+stage:ramp, data=energy2)
summary(e1)
check_assumptions(e1)
hist(e1$residuals, main = "Residual Histogram")
ols_test_normality(e1) #Kolmogorov: data is  normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(e1, test="Chisq")

e2 <- update(e1, .~. -stage:ramp)
drop1(e2, test="Chisq")

e3 <- update(e2, .~. -weight)
drop1(e3, test="Chisq")

e4 <- update(e3, .~. -ramp)
drop1(e4, test="Chisq")

```

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(e4)
hist(e4$residuals, main = "Residual Histogram")
ols_test_normality(e4) #Kolmogorov: data is  normal
```
### Summary and result plots

```{r, eval=FALSE, echo=FALSE}
summary(e4)
sjPlot::tab_model(e4, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Activation energy per stage and date"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Energy_stage.doc")


# Making the plot
nd = expand.grid(ramp=seq(0.2,0.25,0.005), stage=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male"), date="2022-06-22")
predicted.e4 <- augment(e4, newdata = nd, se_fit=TRUE)
stats.e4<-glance(e4)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.e4$df.residual)
predicted.e4$lwr <- with(predicted.e4, .fitted - tcrit * .se.fit) # 95% confidence interval as estimated when doing the continuous line
predicted.e4$upr <- with(predicted.e4, .fitted + tcrit * .se.fit)
predicted.e4$lwr2 <- with(predicted.e4, .fitted - 1.96 * .se.fit)# 95% confidence interval as estimated when doing the vcategorical variables in Drew's class
predicted.e4$upr2 <- with(predicted.e4, .fitted + 1.96 * .se.fit)
predicted.e4$lwr3 <- with(predicted.e4, .fitted -  .se.fit) #Using just the standard error
predicted.e4$upr3 <- with(predicted.e4, .fitted + .se.fit)


# Plot with prediction trends, confidence intervals and data
e4plot<-ggplot(energy2, aes(x = stage))+ 
  geom_point(aes(y = slope, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.e4,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr, ymax = upr, group=stage), color = "black", data = predicted.e4, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")
e4plot

# Plot with prediction trends, confidence interval 2 and data
e4plot<-ggplot(energy2, aes(x = stage))+ 
  geom_point(aes(y = slope, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.e4,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr2, ymax = upr2, group=stage), color = "black", data = predicted.e4, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")
e4plot

# Plot with prediction trends, standard error and data
e4plot<-ggplot(energy2, aes(x = stage))+ 
  geom_point(aes(y = slope, color=stage), size = 3, shape=1)  + 
  geom_point(aes(y = .fitted, color=stage),color = "black", size = 2, data = predicted.e4,position=position_nudge(x=0.1), width=0.2) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = predicted.e4, inherit.aes = FALSE,position=position_nudge(x=0.1), width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")
e4plot


# check Chads code
ggplot(energy2, aes(x=stage, y=slope, color=stage))+
  geom_point(shape=1, size=3, stroke=1.2)+
  scale_fill_brewer(palette="Set1")+
  stat_summary(geom="point", fun=mean, size=3, color="black", position=position_nudge(x=0.1))+
  stat_summary(geom="errorbar", fun.data=mean_se, width=0.1, position=position_nudge(x=0.1), color="black")+
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")









ggsave(plot=last_plot(),filename="Ropt_stage_minustrial2.jpg",  path="Outputs/Statistics/")


# Making the plot for date
nd = expand.grid(ramp=0.225, stage=c("Protonymph"), date=factor(levels(as.factor(energy2$date))))
predicted.e4 <- augment(e4, newdata = nd)

# reuse ggplot object from above. fix color to black or geom_line looks for fBeach. x aesthetic inherited from Richness_NAP
e4plot2 <- ggplot(energy, aes(x = date, y = slope)) + 
  geom_point(aes(y = .fitted), data = predicted.e4)+ylab("Äctivation energy") + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Date")+
  ylab("Activation energy")
e4plot2 
ggsave(plot=last_plot(),filename="Energy_stage_weight.jpg",  path="Outputs/Statistics/")




```


## Plotting from the raw data

```{r, eval=FALSE, echo=FALSE}
averages<-energy2%>%
  group_by(stage,date ) %>%
  summarize(mean=mean(slope), sd=sd(slope), n=n(), sem=sd/sqrt(n)) %>% 
  mutate_all(~replace(., is.na(.), 0))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
e4plot<-ggplot(energy2, aes(x = stage))+ 
  geom_point(aes(y = slope, color=date), size = 3, shape=1, stroke=1)  + 
  geom_point(aes(y = mean, color=date), size = 3, data = averages, position=position_nudge(x=0.2)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=date, color=date),  data = averages, inherit.aes = FALSE, position=position_nudge(x=0.2), width=0.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")
e4plot

```



## Looking at weight

### Global model
```{r, eval=FALSE, echo=FALSE}
e5<-lm(slope~stage+date+weight+ramp+weight:ramp, data=energy2)
summary(e5)
check_assumptions(e5)
hist(e5$residuals, main = "Residual Histogram")
ols_test_normality(e5) #Kolmogorov: data is normal
```

### Backwards selection
```{r, eval=FALSE, echo=FALSE}
# Doing backwards selection
drop1(e5, test="Chisq")

e6 <- update(e5, .~. -stage)
drop1(e6, test="Chisq")
```

### Checking assumptions
```{r, eval=FALSE, echo=FALSE}
check_assumptions(e6)
hist(e6$residuals, main = "Residual Histogram")
ols_test_normality(e6) #Kolmogorov: data is  normal
```


```{r, eval=FALSE, echo=FALSE}
summary(e6)
sjPlot::tab_model(e6, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = T,
                  dv.labels = c("Activation energy per weight and date"), 
                  string.se = "SE", transform = NULL, file = "Outputs/Statistics/Energy_weight.doc")



# Making the plot
nd = expand.grid(ramp=seq(0.24,0.26,0.005), weight=c(0.1, 1.1, 2.3), date="2022-06-22")
predicted.e6 <- augment(e6, newdata = nd, se_fit=TRUE)
stats.e6<-glance(e6)


# calculate the lower and upper 95% confidence limits on the mean
tcrit <- qt(0.975, df = stats.e6$df.residual)
predicted.e6$lwr <- with(predicted.e6, .fitted - tcrit * .se.fit)
predicted.e6$upr <- with(predicted.e6, .fitted + tcrit * .se.fit)



# Plot with prediction trends, confidence intervals and data
e6plot<-ggplot(energy2, aes(x = ramp))+ 
  geom_line(aes(y = .fitted, color=weight, group=as.factor(weight),linetype = as.factor(weight)), 
            data = predicted.e6, size = 2)+#scale_color_continuous(trans = 'reverse') + 
  geom_ribbon(aes(ymin = lwr, ymax = upr, group=as.factor(weight), fill=weight), 
              data = predicted.e6, alpha = 0.5) + theme_classic()+ theme(text = element_text(size = 15))+#scale_color_continuous(trans = 'reverse')+ 
  xlab("Heat ramping rate (Celsius/minute)")+
  ylab("Activation energy") + 
  geom_point(aes(y = slope, color=weight), size = 3)+ scale_color_gradient(low="#9ecae1", high="#08306b")+ scale_fill_gradient(low="#9ecae1", high="#08306b")
e6plot


# Plot with prediction trends, standard error and data
e6plot2<-ggplot(energy2, aes(x = ramp))+ 
  geom_point(aes(y = slope, color=date), size = 3, shape=1, stroke=1)  + 
  geom_point(aes(y = mean, color=date), size = 3, data = averages, position=position_nudge(x=0.2)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=date, color=date),  data = averages, inherit.aes = FALSE, position=position_nudge(x=0.2), width=0.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Activation energy")
e6plot2


ggsave(plot=last_plot(), filename="Ropt_weight.jpg",  path="Outputs/Statistics/")
```


Kennas code for saving output as word doc:
sjPlot::tab_model(prop.mod, show.se = T, show.ci = F, show.re.var = F, show.intercept = T, 
                  show.icc = FALSE, show.ngroups = F, show.r2 = F,
                  dv.labels = c("Proportion of time spent on correct side"), 
                  string.se = "SE", transform = NULL, file = here::here("output/3.table_proptime.doc"))

