---
title: "Environment curves vs performance"
author: "Laura Segura Hernández"
date: "10/17/2022"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/laus1/OneDrive - University of Nebraska-Lincoln/UNL/PhD Tesis/Methods/Thermolimit/Thermolimit data analyses")
getwd()
```

#Libraries
```{r}
library(lme4)
library(dplyr)
library(forcats)
library(NRES803)
library(olsrr)
library(broom)
library(ggplot2)
library(lmerTest)
library(ggpubr)
library(grid)
library(purrr)
library(scales)
```



# Performance data
## Calling the  data
```{r}
derivs2<-read.csv("Outputs/derivsdemography_manualtrim.csv")
derivs2<-derivs2%>%
  rename(ind=id.x)%>%
  filter(trial!=2) %>%
  filter(first2>=0) %>%
  filter(!ind %in% c(87,54,244)) #Removing outliers for ropt (as selected in the "Thermolimit statistical analyses" script)
data<-read.csv("Data/Environment/Datos pseudos summer 2022 - Data.csv")
data<-data%>%
  select(1,2,4) %>%
  rename(ind=ID)
derivs2<-left_join(derivs2, data, by="ind")
```



# Environmental data
The files used to get the environmental data were previously modified in the script named "Processing2 final data for models", located  in the folders Methods/HOBO dataloggers/Data CPBS summer 2020/Final data. 



# Looking at the overall microhabitat means (plant+topsoil)

```{r}
micro<-read.csv("./Data/Environment/microhabtempsmerge3means.csv")
colnames(micro)
micro<-micro%>%
  select(!contains("10cm"))%>%
  rename("date2"="date2.x.x",
         "time"="time.x.x",
         "SOILdead_site1"="SOILdead_tempDeadtopCPBS_G1.csvB.csv",
         "SOILdead_site2"="SOILdead_tempDeadtopCPBS_G2.csvB.csv",
         "SOILdead_site3"="SOILdead_tempDeadtopCPBS_G3.csvB.csv",
         "SOILdead_site4"="SOILdead_tempDeadtopCPBS_G4.csvB.csv",
         "SOILdead_site5"="SOILdead_tempDeadtopCPBS_G5.csvB.csv",
         "SOILdead_site6"="SOILdead_tempDeadtopCPBS_G6.csvB.csv",
         "SOILdead_site7"="SOILdead_tempDeadtopCPBS_G7.csvB.csv",
         "SOILdead_site8"="SOILdead_tempDeadtopCPBS_G8.csvB.csv",
         "SOILdead_site9"="SOILdead_tempDeadtopCPBS_G9.csvB.csv",
         "SOILlive_site1"="SOILlive_tempLivetopCPBS_G1.csvB.csv",
         "SOILlive_site2"="SOILlive_tempLivetopCPBS_2.csvB.csv",
         "SOILlive_site3"="SOILlive_tempLivetopCPBS_G3.csvB.csv",
         "SOILlive_site4"="SOILlive_tempCPBS_G4.csvB.csv",
         "SOILlive_site5"="SOILlive_tempCPBS_G5.csvB.csv",
         "SOILlive_site6"="SOILlive_tempLivetopCPBS_G6.csvB.csv",
         "SOILlive_site7"="SOILlive_tempLivetopCPBS_G7.csvB.csv",
         "SOILlive_site8"="SOILlive_tempLivetopCPBS_G8.csvB.csv",
         "SOILlive_site9"="SOILlive_tempLivetopCPBS_G9.csvB.csv",
         "PLANTdeadcore_site2"="PLANTdead_core2",
         "PLANTdeadleaves_site2"="PLANTdead_leaves2",
         "PLANTdeadcore_site3"="PLANTdead_core3",
         "PLANTdeadleaves_site3"="PLANTdead_leaves3",
         "PLANTdeadleaves_site6"="PLANTdead_leaves6",
         "PLANTdeadcore_site6"="PLANTdead_core6",
         "PLANTdeadcore_site8"="PLANTdead_core8",
         "PLANTdeadleaves_site8"="PLANTdead_leaves8",
         "PLANTliveleaves_site2"="PLANTlive_top_leaves2",
         "PLANTliveleaves_b_site2"="PLANTlive_bottom_leaves2",
         "PLANTliveleaves_site6"="PLANTlive_top_leaves6",
         "PLANTliveleaves_b_site6"="PLANTlive_bottom_leaves6",
         "PLANTliveleaves_site9"="PLANTlive_top_leaves9") %>%
  mutate(means2=apply(micro[,5:35],1, mean, na.rm=T), 
         sd=apply(micro[,5:35],1, sd, na.rm=T),
         diff=means-means2,
         tempcorr=means2,
         date2=as.POSIXct(date2, format="%m/%d/%y")) 
micro<-subset(micro, date2 >"2020-05-30" & date2 < "2020-08-04") #Choosing same dates as for future projections
  
colnames(micro)
```

# ##########################################################################################################################################

## For the whole season

# #################################################################

### For the whole area
```{r}
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
ggplot(micro, aes(x=means2))+
  geom_histogram()+
  geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=medianline, color="blue")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Microclimate temperature (Celsius)")+
  ylab("Frequency")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))
ggsave(plot=last_plot(),filename="Climate_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
```


##### Plotting for all life stages
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(micro$means2), color="#d95f02")+
  theme_classic()+
   theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(protos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Proto_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Deutonymphs
deutos<- derivs2%>%
  filter(stage=="Deutonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(micro$means2), color="#d95f02")+
  theme_classic()+
   theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(deutos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Deuto_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Tritonymphs
tritos<- derivs2%>%
  filter(stage=="Tritonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(micro$means2), color="#d95f02")+
  theme_classic()+
   theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(tritos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Trito_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Males
males <- derivs2%>%
  filter(stage=="Male")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(micro$means2), color="#d95f02")+
  theme_classic()+
   theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(males, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Male_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Females
females <- derivs2%>%
  filter(stage=="Female")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-4000000000
fems<-ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(micro$means2), color="#d95f02")+
  theme_classic()+
   theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(females, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
fems
ggsave(plot=last_plot(),filename="Female_allseason_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
```



# #################################################################

### Separating by sites
#### Separating environmental data
```{r}
microtemp<-micro%>%
  select(contains("site1")) 
last<-as.numeric(ncol(microtemp))
micro1<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site2")) 
last<-as.numeric(ncol(microtemp))
micro2<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site3")) 
last<-as.numeric(ncol(microtemp))
micro3<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site4")) 
last<-as.numeric(ncol(microtemp))
micro4<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site5")) 
last<-as.numeric(ncol(microtemp))
micro5<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site6")) 
last<-as.numeric(ncol(microtemp))
micro6<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site7")) 
last<-as.numeric(ncol(microtemp))
micro7<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site8")) 
last<-as.numeric(ncol(microtemp))
micro8<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
microtemp<-micro%>%
  select(contains("site9")) 
last<-as.numeric(ncol(microtemp))
micro9<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(micro[,2:4])
#For site 6
site6max<-max(micro6$means)
site6mean<-mean(micro6$means)
site6median<-median(micro6$means)
#For site 3
site3max<-max(micro3$means)
site3mean<-mean(micro3$means)
site3median<-median(micro3$means)
```

#### Plotting for each life stage
##### Protonymphs
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
#Choosing individuals for site 6
protos6<-protos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
protos3<-protos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- protos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(protos3$ind))
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- protos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(protos6$ind))
plotlist6<-map(ind, plotsite6)
#Cretaing the combined figure
protos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          nrow=3, ncol=4)
protosall<-annotate_figure(protos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
protosall
ggsave(plot=last_plot(),filename="protos_allseason_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

##### Deutonymphs
```{r}
deutos <- derivs2%>%
  filter(stage=="Deutonymph")
#Checking how many sites we need to filter for:
levels(as.factor(deutos$site))
  
#Choosing individuals for site 6
deutos6<-deutos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
deutos3<-deutos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- deutos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(deutos3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- deutos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(deutos6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(deutos$ind))
#Creating the combined figure
deutos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[10]]+ rremove("ylab") + rremove("xlab"),
          nrow=5, ncol=5)
deutosall<-annotate_figure(deutos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
deutosall
ggsave(plot=last_plot(),filename="deutos_allseason_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

##### Tritonymphs
```{r}
tritos <- derivs2%>%
  filter(stage=="Tritonymph")
#Checking how many sites we need to filter for:
levels(as.factor(tritos$site))
  
#Choosing individuals for site 6
tritos6<-tritos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
tritos3<-tritos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- tritos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(tritos3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- tritos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(tritos6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(tritos$ind))
#Creating the combined figure
tritos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[14]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[15]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          nrow=5, ncol=5)
tritosall<-annotate_figure(tritos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
tritosall
ggsave(plot=last_plot(),filename="tritos_allseason_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

##### Males
```{r}
males <- derivs2%>%
  filter(stage=="Male")
#Checking how many sites we need to filter for:
levels(as.factor(males$site))
  
#Choosing individuals for site 6
males6<-males %>%
  filter(site=="site 6")
#Choosing individuals for site 3
males3<-males %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- males3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(males3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- males6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(males6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(males$ind))
#Creating the combined figure
males_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          nrow=5, ncol=5)
malesall<-annotate_figure(males_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
malesall
ggsave(plot=last_plot(),filename="males_allseason_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

##### Females
```{r}
females <- derivs2%>%
  filter(stage=="Female")
#Checking how many sites we need to filter for:
levels(as.factor(females$site))
  
#Choosing individuals for site 6
females6<-females %>%
  filter(site=="site 6")
#Choosing individuals for site 3
females3<-females %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- females3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(females3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- females6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency", sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(females6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(females$ind))
#Creating the combined figure
females_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[14]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[15]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[16]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[17]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          nrow=5, ncol=5)
femalesall<-annotate_figure(females_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
femalesall
ggsave(plot=last_plot(),filename="females_allseason_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

















# ##########################################################################################################################################

## For the warmest month (July)


```{r}
july<-subset(micro, date2 >"2020-06-30" & date2 < "2020-08-01")
```
# #################################################################

#### For the whole area
```{r}
meanline<-mean(july$means2)
medianline<-median(july$means2)
ggplot(july, aes(x=means2))+
  geom_histogram()+
  geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=medianline, color="blue")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Microlimate temperature (Celsius)")+
  ylab("Frequency")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))
ggsave(plot=last_plot(),filename="Climate_July_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
```


##### Plotting for all life stages
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
    
 coeff<-4000000000
ggplot()+
  geom_histogram(july,mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(july$means2), color="#d95f02")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(protos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Proto_july_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Deutonymphs
deutos<- derivs2%>%
  filter(stage=="Deutonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july,mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(july$means2), color="#d95f02")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(deutos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Deuto_july_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Tritonymphs
tritos<- derivs2%>%
  filter(stage=="Tritonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july,mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(july$means2), color="#d95f02")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(tritos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Trito_july_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Males
males <- derivs2%>%
  filter(stage=="Male")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july,mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(july$means2), color="#d95f02")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(males, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Male_july_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Females
females <- derivs2%>%
  filter(stage=="Female")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july,mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  #geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=max(july$means2), color="#d95f02")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(females, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Female_july_allarea.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
```



# #################################################################

#### Separating by sites
##### Separating environmental data
```{r}
microtemp<-july%>%
  select(contains("site1")) 
last<-as.numeric(ncol(microtemp))
micro1<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site2")) 
last<-as.numeric(ncol(microtemp))
micro2<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site3")) 
last<-as.numeric(ncol(microtemp))
micro3<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site4")) 
last<-as.numeric(ncol(microtemp))
micro4<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site5")) 
last<-as.numeric(ncol(microtemp))
micro5<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site6")) 
last<-as.numeric(ncol(microtemp))
micro6<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site7")) 
last<-as.numeric(ncol(microtemp))
micro7<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site8")) 
last<-as.numeric(ncol(microtemp))
micro8<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
microtemp<-july%>%
  select(contains("site9")) 
last<-as.numeric(ncol(microtemp))
micro9<-microtemp%>%
  mutate(means=apply(microtemp[,1:last],1, mean, na.rm=T))%>%
  cbind(july[,2:4])
#For site 6
site6maxjul<-max(micro6$means)
site6meanjul<-mean(micro6$means)
site6medianjul<-median(micro6$means)
#For site 3
site3maxjul<-max(micro3$means)
site3meanjul<-mean(micro3$means)
site3medianjul<-median(micro3$means)
```

##### Plotting for each life stage
###### Protonymphs
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
#Choosing individuals for site 6
protos6<-protos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
protos3<-protos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- protos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", limits=c(0,400),sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(protos3$ind))
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- protos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(protos6$ind))
plotlist6<-map(ind, plotsite6)
#Creating the combined figure
protos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          nrow=3, ncol=4)
protosall<-annotate_figure(protos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
protosall
ggsave(plot=last_plot(),filename="protos_july_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

###### Deutonymphs
```{r}
deutos <- derivs2%>%
  filter(stage=="Deutonymph")
#Checking how many sites we need to filter for:
levels(as.factor(deutos$site))
  
#Choosing individuals for site 6
deutos6<-deutos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
deutos3<-deutos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- deutos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(deutos3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- deutos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(deutos6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(deutos$ind))
#Creating the combined figure
deutos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[10]]+ rremove("ylab") + rremove("xlab"),
          nrow=5, ncol=5)
deutosall<-annotate_figure(deutos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
deutosall
ggsave(plot=last_plot(),filename="deutos_july_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

###### Tritonymphs
```{r}
tritos <- derivs2%>%
  filter(stage=="Tritonymph")
#Checking how many sites we need to filter for:
levels(as.factor(tritos$site))
  
#Choosing individuals for site 6
tritos6<-tritos %>%
  filter(site=="site 6")
#Choosing individuals for site 3
tritos3<-tritos %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- tritos3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(tritos3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- tritos6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(tritos6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(tritos$ind))
#Creating the combined figure
tritos_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[14]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[15]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"),
          nrow=5, ncol=5)
tritosall<-annotate_figure(tritos_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
tritosall
ggsave(plot=last_plot(),filename="tritos_july_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

###### Males
```{r}
males <- derivs2%>%
  filter(stage=="Male")
#Checking how many sites we need to filter for:
levels(as.factor(males$site))
  
#Choosing individuals for site 6
males6<-males %>%
  filter(site=="site 6")
#Choosing individuals for site 3
males3<-males %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- males3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(males3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- males6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(males6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(males$ind))
#Creating the combined figure
males_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[7]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[8]]+ rremove("ylab") + rremove("xlab"), 
          nrow=5, ncol=5)
malesall<-annotate_figure(males_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
malesall
ggsave(plot=last_plot(),filename="males_july_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```

###### Females
```{r}
females <- derivs2%>%
  filter(stage=="Female")
#Checking how many sites we need to filter for:
levels(as.factor(females$site))
  
#Choosing individuals for site 6
females6<-females %>%
  filter(site=="site 6")
#Choosing individuals for site 3
females3<-females %>%
  filter(site=="site 3")
coeff<-4000000000
#Creating plots for site 3
plotsite3 = function(ind) {
  #Creating histogram for conditions in site 3
  histo3<-ggplot()+
  geom_histogram(micro3, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro3$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- females3 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo3+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="orange", size=1.3)+
  scale_y_continuous("Frequency", limits=c(0,400),sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(females3$ind))
ind
plotlist3<-map(ind, plotsite3)
#Creating plots for site 6
plotsite6 = function(ind) {
  #Creating histogram for conditions in site 6
  histo6<-ggplot()+
  geom_histogram(micro6, mapping=aes(x=means))+
  geom_vline(xintercept=max(micro6$means), color="blue")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Temperature (°C)")
  
  #Filtering for each individual
   pd<- females6 %>%
    filter(.data$ind==.env$ind)
   
   #Adding the line for each individual
    histo6+ 
    geom_line(pd, mapping=aes(y=first2*coeff,x=tempcorr),color="red", size=1.3)+
  scale_y_continuous("Frequency",limits=c(0,400), sec.axis = sec_axis(~ ./coeff, name = "Rate optima (Oxygen (mg/L)/ time(min))"))
   
      }
ind<-levels(as.factor(females6$ind))
plotlist6<-map(ind, plotsite6)
ind<-levels(as.factor(females$ind))
#Creating the combined figure
females_all<-ggarrange(plotlist3[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[2]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[3]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[4]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[5]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[6]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[7]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[8]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[9]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[10]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[11]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[12]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[13]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[14]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[15]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[16]]+ rremove("ylab") + rremove("xlab"),
          plotlist3[[17]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[1]]+ rremove("ylab") + rremove("xlab"),
          plotlist6[[2]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[3]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[4]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[5]]+ rremove("ylab") + rremove("xlab"), 
          plotlist6[[6]]+ rremove("ylab") + rremove("xlab"), 
          nrow=5, ncol=5)
femalesall<-annotate_figure(females_all, left = textGrob("Frequency", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Temperature (°C)", gp = gpar(cex = 1.3)), right=textGrob("Oxygen consumed ((mg/L)/min)", rot = 270, vjust = 1, gp = gpar(cex = 1.3)))
femalesall
ggsave(plot=last_plot(),filename="females_july_persite.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```


























# ##########################################################################################################################################



# Adding future temperatures

The file  I used are the ones from the models that were used for the survival experiment. I made sure to use the right files, before future temperatures were trimmed below 44 C due to limitations of the incubators. I also just used the projections created from June 1st to august 3rd. 

```{r}
future<-read.csv("Data/Environment/Future microclimate data.csv")
```

## For the whole season

# #################################################################

### For the whole area
```{r}
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
meanlinef<-mean(future$temp)
medianlinef<-median(future$temp)
ggplot(micro, aes(x=means2))+
  geom_histogram(fill="#d95f02", alpha=0.5)+
  geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=medianline, color="#d95f02")+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=meanlinef, color="red", linetype="dashed")+
  geom_vline(xintercept=medianlinef, color="#7570b3",linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Microclimate temperature (Celsius)")+
  ylab("Frequency")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))
ggsave(plot=last_plot(),filename="Climate_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
```

### Temperature ranges

```{r}

#For the whole season
## Current
round(min(micro$means2), digits=2) #min
round(max(micro$means2), digits=2) #max
round((max(micro$means2)-min(micro$means2)), digits=2) #range
round(mean(micro$means2), digits=2) #mean
round(sd(micro$means2), digits=2) #sd
round((sd(micro$means2)/length(micro$means2)), digits=3) #se

## Future
round(min(future$temp), digits=2) #min
round(max(future$temp), digits=2) #max
round((max(future$temp)-min(future$temp)), digits=2) #range
round(mean(future$temp), digits=2) #mean
round(sd(future$temp), digits=2) #sd
round((sd(future$temp)/length(future$temp)), digits=3) #se



#Per day
## Current
dailycurr<- micro %>%
  group_by(date2) %>%
  summarize(max=max(means2), min=min(means2), mean=mean(means2), sd=sd(means2)) %>%
  mutate(range=max-min)
n<-length(dailycurr$date2)

round(mean(dailycurr$min), digits=2) #min mean
round(sd(dailycurr$min), digits=2) #min sd
round((sd(dailycurr$min)/n), digits=2) #min se

round(mean(dailycurr$max), digits=2) #max mean
round(sd(dailycurr$max), digits=2) #max sd
round((sd(dailycurr$max)/n), digits=2) #max se

round(mean(dailycurr$range), digits=2) #range
round(sd(dailycurr$range), digits=2) #range sd
round((sd(dailycurr$range)/n), digits=2) #range se

round(mean(dailycurr$mean), digits=2) #mean
round(sd(dailycurr$mean), digits=2) #mean sd
round((sd(dailycurr$mean)/n), digits=2) #mean se



## Future
dailyfut<- future %>%
  group_by(month2, day) %>%
  summarize(max=max(temp), min=min(temp), mean=mean(temp), sd=sd(temp)) %>%
  mutate(range=max-min)
n<-length(dailyfut$day)

round(mean(dailyfut$min), digits=2) #min mean
round(sd(dailyfut$min), digits=2) #min sd
round((sd(dailyfut$min)/n), digits=2) #min se

round(mean(dailyfut$max), digits=2) #max mean
round(sd(dailyfut$max), digits=2) #max sd
round((sd(dailyfut$max)/n), digits=2) #max se

round(mean(dailyfut$range), digits=2) #range
round(sd(dailyfut$range), digits=2) #range sd
round((sd(dailyfut$range)/n), digits=2) #range se

round(mean(dailyfut$mean), digits=2) #mean
round(sd(dailyfut$mean), digits=2) #mean sd
round((sd(dailyfut$mean)/n), digits=2) #mean se


```


##### Plotting for all life stages
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-700000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(micro$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(future$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(protos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Proto_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Deutonymphs
deutos<- derivs2%>%
  filter(stage=="Deutonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-700000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(micro$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(future$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(deutos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Deuto_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Tritonymphs
tritos<- derivs2%>%
  filter(stage=="Tritonymph")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-700000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(micro$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(future$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(tritos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Trito_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Males
males <- derivs2%>%
  filter(stage=="Male")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-700000000
ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(micro$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(future$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(males, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Male_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Females
females <- derivs2%>%
  filter(stage=="Female")
  
meanline<-mean(micro$means2)
medianline<-median(micro$means2)
coeff<-700000000
fems<-ggplot()+
  geom_histogram(micro, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(future, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(micro$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(future$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(females, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO[2]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
fems
ggsave(plot=last_plot(),filename="Female_allseason_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
```





 ##########################################################################################################################################

## For the warmest month (July)


```{r}
julyf<-subset(future, month2==7)
```
# #################################################################

#### For the whole area
```{r}
meanline<-mean(july$means2)
medianline<-median(july$means2)
meanlinef<-mean(julyf$temp)
medianlinef<-median(julyf$temp)
ggplot(july, aes(x=means2))+
  geom_histogram(fill="#d95f02", alpha=0.5)+
  geom_vline(xintercept=meanline, color="red")+
  geom_vline(xintercept=medianline, color="#d95f02")+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=meanlinef, color="red", linetype="dashed")+
  geom_vline(xintercept=medianlinef, color="#7570b3",linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Microclimate temperature (Celsius)")+
  ylab("Frequency")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))
ggsave(plot=last_plot(),filename="Climate_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
```


##### Plotting for all life stages
```{r}
##### Protonymphs
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(july$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(julyf$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(protos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Proto_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Deutonymphs
deutos<- derivs2%>%
  filter(stage=="Deutonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(july$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(julyf$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(deutos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Deuto_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Tritonymphs
tritos<- derivs2%>%
  filter(stage=="Tritonymph")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(july$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(julyf$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(tritos, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Trito_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Males
males <- derivs2%>%
  filter(stage=="Male")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(july$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(julyf$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)),strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(males, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Male_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")
  
##### Females
females <- derivs2%>%
  filter(stage=="Female")
  
meanline<-mean(july$means2)
medianline<-median(july$means2)
coeff<-4000000000
ggplot()+
  geom_histogram(july, mapping=aes(x=tempcorr),fill="#d95f02", alpha=0.5)+
  geom_histogram(julyf, mapping=aes(x=temp),fill="#7570b3", alpha=0.5)+
  geom_vline(xintercept=max(july$means2), color="#d95f02",linetype="solid")+
  geom_vline(xintercept=max(julyf$temp), color="#7570b3", linetype="dashed")+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)), strip.text.x = element_blank(),panel.spacing = unit(7, "mm"))+
  xlab("Temperature (°C)")+
  scale_x_continuous(limits=c(5,55), breaks=c(5,20,35,50))+
  geom_line(females, mapping=aes(y=first2*coeff,x=tempcorr))+
  scale_y_continuous("Frequency",  sec.axis = sec_axis(~ ./coeff, name = bquote(VO2[Max]~(mg~min^-1)), labels = scales::scientific)) + 
  facet_wrap(vars(ind))+
  labs(colour = "Trial")
ggsave(plot=last_plot(),filename="Female_july_allarea_future.jpg",  path="Outputs/Microclimate vs performance/",width=7, height=7, units="in")


```




























# ###########################################################################################################################################

# Calculating differences between microclimate and performance

```{r}
dat<-read.csv("Outputs/ToptandRopts_trim.csv")
dat<-dat%>%
  filter(ind!=213) %>% #213 was a very flat line, we have dowubts about whether there was a leak
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male", "Female"))) %>%
  arrange(stage) %>%
  mutate(date=fct_relevel(date, levels=c("2022-06-23", "2022-06-21", "2022-06-22", "2022-06-24"))) %>%
  arrange(date)
#Adding site to the data
data<-read.csv("Data/Environment/Datos pseudos summer 2022 - Data.csv")
data<-data%>%
  select(1,2,4) %>%
  rename(ind=ID)
dat<-left_join(dat, data, by="ind")
sample<-dat %>%
  group_by(stage) %>%
  summarize(n=n())
sample
```

## Estimating environmental values
```{r}
#Current 
##All area, all season
allmax<-max(micro$means2)
allmean<-mean(micro$means2)
allmedian<-median(micro$means2)
##All area, july
julmax<-max(july$means2)
julmean<-mean(july$means2)
julmedian<-median(july$means2)
#Future 
##All area, all season
allmaxf<-max(future$temp)
allmeanf<-mean(future$temp)
allmedianf<-median(future$temp)
##All area,july
julmaxf<-max(julyf$temp)
julmeanf<-mean(julyf$temp)
julmedianf<-median(julyf$temp)
```
## Estimating differences

```{r}
diffs<-dat%>%
  mutate(currentallmax=tempcorr-allmax,
         currentallmean=tempcorr-allmean,
         currentallmedian=tempcorr-allmedian,
         currentjulmax=tempcorr-julmax,
        currentjulmean=tempcorr-julmean,
        currentjulmedian=tempcorr-julmedian,
        futureallmax=tempcorr-allmaxf,
        futureallmean=tempcorr-allmeanf,
        futureallmedian=tempcorr-allmedianf,
        futurejulmax=tempcorr-julmaxf,
        futurejulmean=tempcorr-julmeanf,
        futurejulmedian=tempcorr-julmedianf)
diffsum<-diffs%>%select(15:26) %>% na.omit()
diffsumallmeans<-as.data.frame(sapply(diffsum, mean))
diffsumallsd<-as.data.frame(sapply(diffsum, sd))
diffsall<-bind_cols(diffsumallmeans,diffsumallsd) 
diffsallfinal<-diffsall%>%
  rename("means"="sapply(diffsum, mean)", "sd" ="sapply(diffsum, sd)") %>%
  mutate(se=sd/sqrt(as.numeric(nrow(diffsum))))
sd(diffsum$currentallmax)
sd(diffsum$futurejulmax)
diffs3<-diffs %>%
  filter(site=="site 3") %>%
  mutate(site3allmax=tempcorr-site3max,
         site3allmean=tempcorr-site3mean,
         site3allmedian=tempcorr-site3median,
         site3julmax=tempcorr-site3maxjul,
         site3julmean=tempcorr-site3meanjul,
         site3julmedian=tempcorr-site3medianjul)
diffsum<-diffs3%>%select(27:32) %>% na.omit()
diffsumallmeans<-as.data.frame(sapply(diffsum, mean))
diffsumallsd<-as.data.frame(sapply(diffsum, sd))
diffsall<-bind_cols(diffsumallmeans,diffsumallsd) 
diffs3summ<-diffsall%>%
  rename("means"="sapply(diffsum, mean)", "sd" ="sapply(diffsum, sd)") %>%
  mutate(se=sd/sqrt(as.numeric(nrow(diffsum))))
diffs6<-diffs %>%
  filter(site=="site 6") %>%
  mutate(site6allmax=tempcorr-site6max,
         site6allmean=tempcorr-site6mean,
         site6allmedian=tempcorr-site6median,
         site6julmax=tempcorr-site6maxjul,
         site6julmean=tempcorr-site6meanjul,
         site6julmedian=tempcorr-site6medianjul)
diffsum<-diffs6%>%select(27:32) %>% na.omit()
diffsumallmeans<-as.data.frame(sapply(diffsum, mean))
diffsumallsd<-as.data.frame(sapply(diffsum, sd))
diffsall<-bind_cols(diffsumallmeans,diffsumallsd) 
diffs6summ<-diffsall%>%
  rename("means"="sapply(diffsum, mean)", "sd" ="sapply(diffsum, sd)") %>%
  mutate(se=sd/sqrt(as.numeric(nrow(diffsum))))
diffsumall<-bind_rows(diffsallfinal, diffs3summ, diffs6summ) 
diffsumall<-diffsumall %>%
  mutate(names=row.names(diffsumall),
         lwr=means-se, 
         upr=means+se)
diffs<-bind_rows(diffs3, diffs6)
write.csv(diffs, "Outputs/toptvsenv.csv")
```

```{r}
# Comparing max, mean, and median differences for all season, all area on current
p1<-ggplot(diffs, aes(y=currentallmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p2<-ggplot(diffs, aes(y=currentallmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p3<-ggplot(diffs, aes(y=currentallmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p1,p2,p3,nrow=1,ncol=3)  
# Comparing max, mean, and median differences for july, all area on current
p4<-ggplot(diffs, aes(y=currentjulmax)) + geom_boxplot() + scale_y_continuous(limits=c(-5, 25))
p5<-ggplot(diffs, aes(y=currentjulmean)) + geom_boxplot() + scale_y_continuous(limits=c(-5, 25))
p6<-ggplot(diffs, aes(y=currentjulmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p4,p5,p6,nrow=1,ncol=3)  
# Comparing max, mean, and median differences for all season, all area on future
p7<-ggplot(diffs, aes(y=futureallmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p8<-ggplot(diffs, aes(y=futureallmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p9<-ggplot(diffs, aes(y=futureallmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p7,p8,p9,nrow=1,ncol=3)  
# Comparing max, mean, and median differences for july, all area on future
p10<-ggplot(diffs, aes(y=futurejulmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p11<-ggplot(diffs, aes(y=futurejulmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p12<-ggplot(diffs, aes(y=futurejulmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p10,p11,p12,nrow=1,ncol=3) 
#Comparing current vs future all season
ggarrange(p1,p7,p2,p8,nrow=2,ncol=2) 
ggarrange(p4,p10,p5,p11,nrow=2,ncol=2) 
# Comparing max, mean, and median differences for all season, site 3 on current
p13<-ggplot(diffs, aes(y=site3allmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p14<-ggplot(diffs, aes(y=site3allmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p15<-ggplot(diffs, aes(y=site3allmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p13,p14,p15,nrow=1,ncol=3) 
# Comparing max, mean, and median differences for july, site 3 on current
p16<-ggplot(diffs, aes(y=site3julmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p17<-ggplot(diffs, aes(y=site3julmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p18<-ggplot(diffs, aes(y=site3julmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p16,p17,p18,nrow=1,ncol=3) 
# Comparing max, mean, and median differences for all season, site 6 on current
p19<-ggplot(diffs, aes(y=site6allmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p20<-ggplot(diffs, aes(y=site6allmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p21<-ggplot(diffs, aes(y=site6allmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p19,p20,p21,nrow=1,ncol=3) 
# Comparing max, mean, and median differences for july, site 6 on current
p22<-ggplot(diffs, aes(y=site6julmax)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p23<-ggplot(diffs, aes(y=site6julmean)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
p24<-ggplot(diffs, aes(y=site6julmedian)) + geom_boxplot()+ scale_y_continuous(limits=c(-5, 25))
ggarrange(p22,p23,p24,nrow=1,ncol=3) 
ggarrange(p1, p13, p2, p15, nrow=2, ncol=2)
ggarrange(p1, p19, p2, p20, nrow=2,ncol=2)
ggarrange(p1, p16, p2, p17, nrow=2,ncol=2)
ggarrange(p1, p22, p2, p23, nrow=2,ncol=2)
diffsmax<-diffsumall %>%
  filter(grepl("max", names))
diffsmean<-diffsumall %>%
  filter(grepl("mean", names))
plot<-ggplot(diffsmax, aes(x =names, color=names))+ 
  geom_point(aes(y = means), size = 2,  width=0.2) + 
  geom_errorbar(aes(x=names, ymin = lwr, ymax = upr),   width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Parameter")+
  ylab("Difference with respect to Topt")
plot
ggsave(plot=last_plot(),filename="environmenttoptdiffs_maxs.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
plot<-ggplot(diffsmean, aes(x =names, color=names))+ 
  geom_point(aes(y = means), size = 2,  width=0.2) + 
  geom_errorbar(aes(x=names, ymin = lwr, ymax = upr),   width=0.2) + theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Parameter")+
  ylab("Difference with respect to Topt")
plot
ggsave(plot=last_plot(),filename="environmenttoptdiffs_means.jpg",  path="Outputs/Microclimate vs performance/",width=10, height=7, units="in")
```