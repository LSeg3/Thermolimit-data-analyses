---
title: "Oxygen estimation"
author: "Laura Segura Hern√°ndez"
date: "2022-08-07"
output:
  html_document:
    df_print: paged
    theme: cerulean
    toc: true
    toc_depth: 4
    number_sections: true
    toc_float: false
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_knit$set(root.dir = "C:/Users/laus1/OneDrive - University of Nebraska-Lincoln/UNL/PhD Tesis/Methods/Thermolimit/Thermolimit data analyses")
getwd()
```

This is the final code to use. The other script for oxygen estimation for some reason lost part of the code. I made this copy after that, with hopefully the whole code again. Use this file for the oxygen estimation, not the other (incomplete) one.


What to do next (10oct22):  

* **For Activation energy:**

** Check if the max points match those of the Topt data
** Clean code, add notes and leave only the final version of the working code on this file

* **For microclimate data:**

** Create a separate script
** plot final curves of Topt  against microclimate
** Clean code, add notes and leave only the final version of the working code on this file



# Libraries
```{r}
library(data.table)
library(tidyr)
library(dplyr)
library(lubridate)
library(ggplot2)
library(fuzzyjoin)
library(forcats)
library(ggpubr)
library(readr)
library(stringr)
library(purrr)
library(knitr)
library(magick)
library(jpeg)
library(grid)



```

# Organizing data

## Getting objects from Temperature Analyses 
```{r}
load("Outputs/Temperature analyses.RData")

#I need to correct the measurments for the volume of the container. The genitalia vial had an internal dimension of 2 mm diameter and 4 mm height. Calculating the volume of the cylinder by h*pi*(r^2), I get 12.5663706143592 mm3
volume<- 12.5663706143592*10^(-6) #converting to Liters
volume


```
## Calling and arranging data

> This is what this code does, per trial:  

1. Prepare the files associated with the trial and brings them into R  
2. Merges them into a single file  
3. Manually adds the information missing to each one. Eg: IDs, weights, stages, etc.  
4. It then call the temperature data and adds it to the file as well  
5. Finally, it add the oxygen data (based on the calculations of the spreadsheet that Jon DeLong provided me) and convert it to mg O2 instead of mg/L 


### Trial 2
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 2/" #MODIFY FOR EACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial2",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t2a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t2b<-t2a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=2,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~250, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~239,
                       str_detect(id, "ch2")~311,
                       str_detect(id, "ch3")~65,
                       str_detect(id, "ch4")~136,
                       str_detect(id, "ch5")~168,
                       str_detect(id, "ch6")~294,
                       str_detect(id, "ch7")~322,
                       str_detect(id, "ch8")~022,
                       str_detect(id, "ch9")~258,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Female",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Tritonymph",
                         str_detect(id, "ch2")~"Protonymph",
                       str_detect(id, "ch3")~"Female",
                       str_detect(id, "ch4")~"Deutonymph",
                       str_detect(id, "ch5")~"Male",
                       str_detect(id, "ch6")~"Protonymph",
                       str_detect(id, "ch7")~"Tritonymph",
                       str_detect(id, "ch8")~"Deutonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Male"),
         weight=case_when(str_detect(id, "ch10")~1.269, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.792,
                       str_detect(id, "ch2")~0.189,
                       str_detect(id, "ch3")~1.714,
                       str_detect(id, "ch4")~0.330,
                       str_detect(id, "ch5")~1.219,
                       str_detect(id, "ch6")~0.240,
                       str_detect(id, "ch7")~0.749,
                       str_detect(id, "ch8")~0.339,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~1.001),
         atm=round(33.864*28.81)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==2) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t2<- full_join(t2b, temp2, by="datetime2", suffix=c("",".temp")) 
  

head(t2) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox2<-t2 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox2) #MODIFY FOR EACH TRIAL

ggplot(ox2, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
 # ylim(8.5,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 3
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 3/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial3",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t3a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t3b<-t3a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=3,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~010, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~231,
                       str_detect(id, "ch2")~029,
                       str_detect(id, "ch3")~087,
                       str_detect(id, "ch4")~166,
                       str_detect(id, "ch5")~300,
                       str_detect(id, "ch6")~121,
                       str_detect(id, "ch7")~014,
                       str_detect(id, "ch8")~271,
                       str_detect(id, "ch9")~143,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Female",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Tritonymph",
                         str_detect(id, "ch2")~"Male",
                       str_detect(id, "ch3")~"Protonymph",
                       str_detect(id, "ch4")~"Female",
                       str_detect(id, "ch5")~"Deutonymph",
                       str_detect(id, "ch6")~"Protonymph",
                       str_detect(id, "ch7")~"Deutonymph",
                       str_detect(id, "ch8")~"Tritonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Male"),
         weight=case_when(str_detect(id, "ch10")~1.228, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.931,
                       str_detect(id, "ch2")~0.924,
                       str_detect(id, "ch3")~0.251,
                       str_detect(id, "ch4")~1.376,
                       str_detect(id, "ch5")~0.289,
                       str_detect(id, "ch6")~0.189,
                       str_detect(id, "ch7")~0.347,
                       str_detect(id, "ch8")~0.647,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~1.021),
         atm=round(33.864*28.81)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==3) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t3<- full_join(t3b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t3) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox3<-t3 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox3) #MODIFY FOR EACH TRIAL

ggplot(ox3, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(7,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 4
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 4/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial4",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t4a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t4b<-t4a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=4,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~213, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~337,
                       str_detect(id, "ch2")~051,
                       str_detect(id, "ch3")~109,
                       str_detect(id, "ch4")~245,
                       str_detect(id, "ch5")~037,
                       str_detect(id, "ch6")~131,
                       str_detect(id, "ch7")~005,
                       str_detect(id, "ch8")~194,
                       str_detect(id, "ch9")~154,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Deutonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Protonymph",
                         str_detect(id, "ch2")~"Deutonymph",
                       str_detect(id, "ch3")~"Tritonymph",
                       str_detect(id, "ch4")~"Male",
                       str_detect(id, "ch5")~"Female",
                       str_detect(id, "ch6")~"Tritonymph",
                       str_detect(id, "ch7")~"Female",
                       str_detect(id, "ch8")~"Male",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Protonymph"),
         weight=case_when(str_detect(id, "ch10")~0.241, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.163,
                       str_detect(id, "ch2")~0.350,
                       str_detect(id, "ch3")~0.730,
                       str_detect(id, "ch4")~0.963,
                       str_detect(id, "ch5")~1.332,
                       str_detect(id, "ch6")~0.509,
                       str_detect(id, "ch7")~1.582,
                       str_detect(id, "ch8")~0.999,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.109),
         atm=round(33.864*28.90)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==4) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t4<- full_join(t4b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t4) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox4<-t4 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox4) #MODIFY FOR EACH TRIAL

ggplot(ox4, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 5
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 5/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial5",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t5a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t5b<-t5a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=5,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~324, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~024,
                       str_detect(id, "ch2")~253,
                       str_detect(id, "ch3")~025,
                       str_detect(id, "ch4")~003,
                       str_detect(id, "ch5")~290,
                       str_detect(id, "ch6")~244,
                       str_detect(id, "ch7")~257,
                       str_detect(id, "ch8")~032,
                       str_detect(id, "ch9")~159,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Protonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Female",
                         str_detect(id, "ch2")~"Male",
                       str_detect(id, "ch3")~"Tritonymph",
                       str_detect(id, "ch4")~"Deutonymph",
                       str_detect(id, "ch5")~"Protonymph",
                       str_detect(id, "ch6")~"Female",
                       str_detect(id, "ch7")~"Male",
                       str_detect(id, "ch8")~"Tritonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Deutonymph"),
         weight=case_when(str_detect(id, "ch10")~0.158, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~1.472,
                       str_detect(id, "ch2")~0.900,
                       str_detect(id, "ch3")~0.688,
                       str_detect(id, "ch4")~0.328,
                       str_detect(id, "ch5")~0.166,
                       str_detect(id, "ch6")~1.454,
                       str_detect(id, "ch7")~0.946,
                       str_detect(id, "ch8")~0.613,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.278),
         atm=round(33.864*28.84)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==5) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t5<- full_join(t5b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t5) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox5<-t5 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox5) #MODIFY FOR EACH TRIAL

ggplot(ox5, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 6
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 6/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial6",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t6a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t6b<-t6a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=6,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~267, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~288,
                       str_detect(id, "ch2")~030,
                       str_detect(id, "ch3")~1000,
                       str_detect(id, "ch4")~287,
                       str_detect(id, "ch5")~218,
                       str_detect(id, "ch6")~238,
                       str_detect(id, "ch7")~165,
                       str_detect(id, "ch8")~298,
                       str_detect(id, "ch9")~066,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Deutonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Deutonymph",
                         str_detect(id, "ch2")~"Female",
                       str_detect(id, "ch3")~"NA",
                       str_detect(id, "ch4")~"Tritonymph",
                       str_detect(id, "ch5")~"Tritonymph",
                       str_detect(id, "ch6")~"Male",
                       str_detect(id, "ch7")~"Protonymph",
                       str_detect(id, "ch8")~"Protonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Female"),
         weight=case_when(str_detect(id, "ch10")~0.221, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.257,
                       str_detect(id, "ch2")~1.583,
                       str_detect(id, "ch3")~1000,
                       str_detect(id, "ch4")~0.583,
                       str_detect(id, "ch5")~0.715,
                       str_detect(id, "ch6")~0.794,
                       str_detect(id, "ch7")~0.142,
                       str_detect(id, "ch8")~0.201,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~2.208),
         atm=round(33.864*28.81)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==6) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t6<- full_join(t6b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t6) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox6<-t6 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox6) #MODIFY FOR EACH TRIAL

ggplot(ox6, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
 # ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 7
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 7/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial7",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t7a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t7b<-t7a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=7,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~274, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~235,
                       str_detect(id, "ch2")~216,
                       str_detect(id, "ch3")~1000,
                       str_detect(id, "ch4")~237,
                       str_detect(id, "ch5")~175,
                       str_detect(id, "ch6")~246,
                       str_detect(id, "ch7")~232,
                       str_detect(id, "ch8")~269,
                       str_detect(id, "ch9")~043,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Deutonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Male",
                         str_detect(id, "ch2")~"Male",
                       str_detect(id, "ch3")~"NA",
                       str_detect(id, "ch4")~"Female",
                       str_detect(id, "ch5")~"Protonymph",
                       str_detect(id, "ch6")~"Female",
                       str_detect(id, "ch7")~"Tritonymph",
                       str_detect(id, "ch8")~"Tritonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Protonymph"),
         weight=case_when(str_detect(id, "ch10")~0.324, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.900,
                       str_detect(id, "ch2")~1.126,
                       str_detect(id, "ch3")~1000,
                       str_detect(id, "ch4")~1.345,
                       str_detect(id, "ch5")~0.213,
                       str_detect(id, "ch6")~1.937,
                       str_detect(id, "ch7")~0.748,
                       str_detect(id, "ch8")~0.622,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.139),
         atm=round(33.864*28.78)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==7) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t7<- full_join(t7b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t7) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox7<-t7 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox7) #MODIFY FOR EACH TRIAL

ggplot(ox7, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
 # ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 8
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 8/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial8",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t8a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t8b<-t8a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=8,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~345, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~301,
                       str_detect(id, "ch2")~107,
                       str_detect(id, "ch3")~54,
                       str_detect(id, "ch4")~270,
                       str_detect(id, "ch5")~85,
                       str_detect(id, "ch6")~36,
                       str_detect(id, "ch7")~112,
                       str_detect(id, "ch8")~138,
                       str_detect(id, "ch9")~80,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Tritonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Protonymph",
                         str_detect(id, "ch2")~"Male",
                       str_detect(id, "ch3")~"Tritonymph",
                       str_detect(id, "ch4")~"Deutonymph",
                       str_detect(id, "ch5")~"Female",
                       str_detect(id, "ch6")~"Protonymph",
                       str_detect(id, "ch7")~"Female",
                       str_detect(id, "ch8")~"Deutonymph",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Male"),
         weight=case_when(str_detect(id, "ch10")~0.863, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.176,
                       str_detect(id, "ch2")~0.648,
                       str_detect(id, "ch3")~0.858,
                       str_detect(id, "ch4")~0.325,
                       str_detect(id, "ch5")~1.863,
                       str_detect(id, "ch6")~0.146,
                       str_detect(id, "ch7")~1.522,
                       str_detect(id, "ch8")~0.329,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~1.199),
         atm=round(33.864*28.72)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==8) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t8<- full_join(t8b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t8) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox8<-t8 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox8) #MODIFY FOR EACH TRIAL

ggplot(ox8, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
 # ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 9
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 9/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial9",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t9a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t9b<-t9a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=9,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~007, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~242,
                       str_detect(id, "ch2")~035,
                       str_detect(id, "ch3")~146,
                       str_detect(id, "ch4")~153,
                       str_detect(id, "ch5")~334,
                       str_detect(id, "ch6")~264,
                       str_detect(id, "ch7")~1000,
                       str_detect(id, "ch8")~004,
                       str_detect(id, "ch9")~228,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Male",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Female",
                         str_detect(id, "ch2")~"Protonymph",
                       str_detect(id, "ch3")~"Male",
                       str_detect(id, "ch4")~"Tritonymph",
                       str_detect(id, "ch5")~"Deutonymph",
                       str_detect(id, "ch6")~"Deutonymph",
                       str_detect(id, "ch7")~"NA",
                       str_detect(id, "ch8")~"Female",
                       #str_detect(id, "ch9")~"Male",
                       TRUE~"Tritonymph"),
         weight=case_when(str_detect(id, "ch10")~0.983, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~1.775,
                       str_detect(id, "ch2")~0.185,
                       str_detect(id, "ch3")~1.118,
                       str_detect(id, "ch4")~0.551,
                       str_detect(id, "ch5")~0.302,
                       str_detect(id, "ch6")~0.342,
                       str_detect(id, "ch7")~1000,
                       str_detect(id, "ch8")~1.425,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.569),
         atm=round(33.864*28.66)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==9) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t9<- full_join(t9b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t9) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox9<-t9 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox9) #MODIFY FOR EACH TRIAL

ggplot(ox9, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 10
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 10/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial10",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t10a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t10b<-t10a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=10,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~179, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~048,
                       str_detect(id, "ch2")~158,
                       str_detect(id, "ch3")~079,
                       str_detect(id, "ch4")~145,
                       str_detect(id, "ch5")~057,
                       str_detect(id, "ch6")~251,
                       str_detect(id, "ch7")~248,
                       str_detect(id, "ch8")~314,
                       str_detect(id, "ch9")~212,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Tritonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Deutonymph",
                         str_detect(id, "ch2")~"Female",
                       str_detect(id, "ch3")~"Female",
                       str_detect(id, "ch4")~"Male",
                       str_detect(id, "ch5")~"Tritonymph",
                       str_detect(id, "ch6")~"Male",
                       str_detect(id, "ch7")~"Male",
                       str_detect(id, "ch8")~"Deutonymph",
                       #str_detect(id, "ch9")~"",
                       TRUE~"Female"),
         weight=case_when(str_detect(id, "ch10")~0.653, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.451,
                       str_detect(id, "ch2")~1.178,
                       str_detect(id, "ch3")~1.781,
                       str_detect(id, "ch4")~0.929,
                       str_detect(id, "ch5")~0.866,
                       str_detect(id, "ch6")~0.941,
                       str_detect(id, "ch7")~0.864,
                       str_detect(id, "ch8")~0.188,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~1.582),
         atm=round(33.864*28.64)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==10) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t10<- full_join(t10b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t10) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox10<-t10 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox10) #MODIFY FOR EACH TRIAL

ggplot(ox10, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 11
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 11/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial11",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t11a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t11b<-t11a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=11,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~141, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~272,
                       str_detect(id, "ch2")~305,
                       str_detect(id, "ch3")~326,
                       str_detect(id, "ch4")~224,
                       str_detect(id, "ch5")~173,
                       str_detect(id, "ch6")~214,
                       str_detect(id, "ch7")~082,
                       str_detect(id, "ch8")~113,
                       str_detect(id, "ch9")~329,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Female",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Tritonymph",
                         str_detect(id, "ch2")~"Deutonymph",
                       str_detect(id, "ch3")~"Deutonymph",
                       str_detect(id, "ch4")~"Female",
                       str_detect(id, "ch5")~"Tritonymph",
                       str_detect(id, "ch6")~"Deutonymph",
                       str_detect(id, "ch7")~"Male",
                       str_detect(id, "ch8")~"Male",
                       #str_detect(id, "ch9")~"",
                       TRUE~"Tritonymph"),
         weight=case_when(str_detect(id, "ch10")~1.853, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.675,
                       str_detect(id, "ch2")~0.312,
                       str_detect(id, "ch3")~0.283,
                       str_detect(id, "ch4")~1.785,
                       str_detect(id, "ch5")~0.566,
                       str_detect(id, "ch6")~0.184,
                       str_detect(id, "ch7")~1.095,
                       str_detect(id, "ch8")~1.046,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.591),
         atm=round(33.864*28.55)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==11) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t11<- full_join(t11b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t11) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox11<-t11 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox11) #MODIFY FOR EACH TRIAL

ggplot(ox11, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)")

```

### Trial 12
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 12/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial12",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t12a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t12b<-t12a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=12,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~339, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~256,
                       str_detect(id, "ch2")~341,
                       str_detect(id, "ch3")~18,
                       str_detect(id, "ch4")~83,
                       str_detect(id, "ch5")~50,
                       str_detect(id, "ch6")~201,
                       str_detect(id, "ch7")~211,
                       str_detect(id, "ch8")~317,
                       str_detect(id, "ch9")~335,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"Deutonymph",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Female",
                         str_detect(id, "ch2")~"Tritonymph",
                       str_detect(id, "ch3")~"Male",
                       str_detect(id, "ch4")~"Male",
                       str_detect(id, "ch5")~"Male",
                       str_detect(id, "ch6")~"Female",
                       str_detect(id, "ch7")~"Female",
                       str_detect(id, "ch8")~"Tritonymph",
                       #str_detect(id, "ch9")~"",
                       TRUE~"Deutonymph"),
         weight=case_when(str_detect(id, "ch10")~0.314, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~1.450,
                       str_detect(id, "ch2")~0.790,
                       str_detect(id, "ch3")~1.23,
                       str_detect(id, "ch4")~1.015,
                       str_detect(id, "ch5")~1.229,
                       str_detect(id, "ch6")~1.49,
                       str_detect(id, "ch7")~1.500,
                       str_detect(id, "ch8")~0.905,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.268),
         atm=round(33.864*28.58)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==12) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t12<- full_join(t12b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t12) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox12<-t12 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox12) #MODIFY FOR EACH TRIAL

ggplot(ox12, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
  #ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg")

```

### Trial 13
```{r}
# creating vector for columns names
cnames<-c("date", "time", "logtime", "oxygen", "phase", "amplitude", "temperature")

# creating vector for path
path<-"Data/Oxygen/Trial 13/" #MODIFY FOR EEACH TRIAL

# Creating list of file names
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

# Renaming files to remove the "-"
newname <- sub('-','', list) ## new name
file.rename(file.path(path,list), file.path(path, newname)) ## renaming it.

# Creating list of file names again
list <- list.files(path = path, pattern=".*txt") # creates the list of all the txt files in the directory

#Reading all files at once
for (i in list) {
  filename <- paste0( "frame",sub(pattern = "(.*)\\..*$", replacement = "\\1", basename(i)))
  wd <- paste0(path, i)
  assign(filename, read.delim2(wd,sep=";", skip=38, header=F, col.names=cnames)) #CHECK FOR EACH TRIALS IF THE SAME NUMBRE OF ROWS APPLIES

}


# Merging all into a single table
pattern<-grep("framepstrial13",names(.GlobalEnv),value=TRUE) #MODIFY FOR EACH TRIAL
list2<-do.call("list",mget(pattern))

t13a<-bind_rows(list2, .id="id") #MODIFY FOR EACH TRIAL


# Adding and modifying data to phase files 
t13b<-t13a %>% #MODIFY FOR EACH TRIAL
  select(c("id", "date", "time", "logtime", "phase")) %>%
  mutate(trial=13,#MODIFY FOR EACH TRIAL
         date=mdy(date), #formatting date
         datetime=paste0(date," ", time), #copying date and time together
         datetime=as_datetime(datetime, format="%Y-%m-%d %I:%M:%S %p")-minutes(9), #adjusting pc time to real time
         datetime2=round_date(datetime, unit="minute"),
         channel=case_when(str_detect(id, "ch10")~10, # Assigning channels 
                       str_detect(id, "ch1")~1,
                       str_detect(id, "ch2")~2,
                       str_detect(id, "ch3")~3,
                       str_detect(id, "ch4")~4,
                       str_detect(id, "ch5")~5,
                       str_detect(id, "ch6")~6,
                       str_detect(id, "ch7")~7,
                       str_detect(id, "ch8")~8,
                       str_detect(id, "ch9")~9,
                       TRUE~0),
         ind=case_when(str_detect(id, "ch10")~1000, # Assigning individuals MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~296,
                       str_detect(id, "ch2")~263,
                       str_detect(id, "ch3")~156,
                       str_detect(id, "ch4")~073,
                       str_detect(id, "ch5")~171,
                       str_detect(id, "ch6")~002,
                       str_detect(id, "ch7")~247,
                       str_detect(id, "ch8")~233,
                       str_detect(id, "ch9")~028,
                       TRUE~0), 
         stage=case_when(str_detect(id, "ch10")~"NA",#Assigning stage MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~"Deutonymph",
                         str_detect(id, "ch2")~"Tritonymph",
                       str_detect(id, "ch3")~"Male",
                       str_detect(id, "ch4")~"Male",
                       str_detect(id, "ch5")~"Deutonymph",
                       str_detect(id, "ch6")~"Tritonymph",
                       str_detect(id, "ch7")~"Female",
                       str_detect(id, "ch8")~"Female",
                       #str_detect(id, "ch9")~"",
                       TRUE~"Tritonymph"),
         weight=case_when(str_detect(id, "ch10")~1000, # Assigning weights MODIFY FOR EACH TRIAL
                       str_detect(id, "ch1")~0.272,
                       str_detect(id, "ch2")~0.764,
                       str_detect(id, "ch3")~0.656,
                       str_detect(id, "ch4")~1.18,
                       str_detect(id, "ch5")~0.361,
                       str_detect(id, "ch6")~0.767,
                       str_detect(id, "ch7")~1.256,
                       str_detect(id, "ch8")~1.693,
                       #str_detect(id, "ch9")~1.001,
                       TRUE~0.866),
         atm=round(33.864*28.55)) #MODIFY FOR EACH TRIAL: 33.864 * pressure in inHg

# Getting temperature for this trial 
temp2<-all_corr %>%
  filter(trial==13) %>% #MODIFY FOR EACH TRIAL
  select(c("datetime2","datetime", "tempcorr", "ramp"))

#Merging phase and temperature data
t13<- full_join(t13b, temp2, by="datetime2", suffix=c("",".temp")) #MODIFY FOR EACH TRIAL 
  

head(t13) #MODIFY FOR EACH TRIAL

#Estimating Oxygen 
f<-pi/180
f


ox13<-t13 %>% #MODIFY FOR EACH TRIAL
  na.omit() %>%
  filter(ind < 900) %>%
  mutate(phase=as.numeric(phase),
         ind=as.factor(ind),
         logtime=as.numeric(logtime),
         phaseangle=62.14-0.08915*tempcorr,
         sternvolmer=0.04899+4.965*10^(-4)*tempcorr,
         bunsen=(48.998-1.335*tempcorr+2.755*10^(-2)*tempcorr^2-3.22*10^(-4)*tempcorr^3+1.598*10^(-6)*tempcorr^4)*10^(-3),
         tempK=tempcorr+273,
         watervapor=exp(52.57-(6690.9/tempK)-4.681*log(tempK)),
         oxysat=(tan((pi/180)*phaseangle)-tan((pi/180)*phase))/tan((pi/180)*phase)*sternvolmer,
         oxymgl=(atm-watervapor)/1013*oxysat*0.2095*bunsen*1000*(32/22.414)*10,
         oxymg=oxymgl*volume)

head(ox13) #MODIFY FOR EACH TRIAL

ggplot(ox13, aes(x=logtime, y=oxymg,group=ind, color=stage))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15))+
#  ylim(8,12) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg")

```

Go back to each trial and annotate the best beginning and end of trial, and change it in the temperature data, then re-run this analysis again, to only get the curves that actual pertain to the trial (i.e. get it from the start and also remove the tail when it warms up again at the end)



# Merging trials into a single dataframe

> Once all trials were done, this part of the code merges them into a single file. Here we also removed the individuals that drowned during the trial, therefore, their traces might not reflect the same information than the rest. 

```{r, eval=F}
oxall<-bind_rows(ox2,ox3,ox4,ox5,ox6,ox7,ox8,ox9,ox10,ox11,ox12,ox13) %>%
filter(!ind%in%c("25","65", "231","82","121", "235")) # Drowned individuals
  


write.csv(oxall,"Outputs/oxygenall_aftercodedeletion.csv") #after code deletion: there was an issue and some changes on the code were not saved. This is the name the file received after that event

```

# Trying which function to use before doing the analyses

> Here, I was exploring which polynomial function would fit the oxygen trace, in order to get the best fit to the curve and extract Topt, Ropt and activation energy later.  
What these code chunks do is:  
1. Filter for a single individual
2. Then try diferent polynomial functions, with degrees from 2 to 10,and see how they fit the data by plotting and looking at the adjusted r-squared values  
3. Estimate the 1st and second derivative for one of the polynomials that best fitted the oxygen trace
4. Get the inflection points for the second derivatives (the point where the second derivative crosses zero, which would mark the places where the first derivative shanges the sign of the slope)

## On individual 232
```{r}

# Filtering for a single individuals to just see the fit
func<-ox7%>%
  filter(ind==232) %>%
  group_by(logtime) %>%
  filter(duplicated(logtime|n()==2))

#Trying different curves
fit2<-lm(oxymg~poly(logtime, 2, raw=TRUE), data=func)
fit3<-lm(oxymg~poly(logtime, 3, raw=TRUE), data=func)
fit4<-lm(oxymg~poly(logtime, 4, raw=TRUE), data=func)
fit5<-lm(oxymg~poly(logtime, 5, raw=TRUE), data=func)
fit6<-lm(oxymg~poly(logtime, 6, raw=TRUE), data=func)
fit7<-lm(oxymg~poly(logtime, 7, raw=TRUE), data=func)
fit8<-lm(oxymg~poly(logtime, 8, raw=TRUE), data=func)
fit9<-lm(oxymg~poly(logtime, 9, raw=TRUE), data=func)
fit10<-lm(oxymg~poly(logtime, 10, raw=TRUE), data=func)

# CReating a dataframe to build the prediction
logtime <- seq(1, 125, length=125)  

# Plotting each predicted function line to the real data
plot(func$logtime, func$oxymg, pch=19, xlab='Logtime', ylab='Oxygen(mg/l)')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='grey')
lines(logtime, predict(fit2, data.frame(x=logtime)), col='red')
lines(logtime, predict(fit3, data.frame(x=logtime)), col='purple')
lines(logtime, predict(fit4, data.frame(x=logtime)), col='blue')
lines(logtime, predict(fit5, data.frame(x=logtime)), col='orange')
lines(logtime, predict(fit6, data.frame(x=logtime)), col='green')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='grey')
lines(logtime, predict(fit8, data.frame(x=logtime)), col='yellow')
lines(logtime, predict(fit9, data.frame(x=logtime)), col='red')
lines(logtime, predict(fit10, data.frame(x=logtime)), col='grey')

#calculated adjusted R-squared of each model

# The adjusted r squared is the percent of the variance of Y intact after subtracting the error of the model. The more the R Squared value the better the model is for that data frame.
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared
summary(fit5)$adj.r.squared
summary(fit6)$adj.r.squared
summary(fit7)$adj.r.squared
summary(fit8)$adj.r.squared
summary(fit9)$adj.r.squared
summary(fit10)$adj.r.squared

coef7<-as.data.frame(fit7$coefficients)
a0<-coef7[1,1]
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1] #cambiar a A
x<-func$logtime
form7<-expression((a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0))
d7<-D(form7, "x") 
d7b<-D(d7, "x")

ggplot(aes(x=logtime, y=oxymg), data=func)+geom_point()
plot(x, func$oxymg, pch=19, xlab='Logtime', ylab='Oxygen(mg)')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='red')

#Primera derivada: tasa con la que consume oxigeno
d7b.data<-as.data.frame(eval(d7, envir=as.data.frame(x)))
colnames(d7b.data)<-"y1"
d7b.data$logtime<-func$logtime
ggplot(aes(x=logtime, y=y1), data=d7b.data)+geom_point()


#Segunda derivada: cruce con y=0 son los punto de cambio, puntos de inflexion donde la pendiente cambia hacia arriva o hacia abajo
d7b.data<-as.data.frame(eval(d7b, envir=as.data.frame(x)))
colnames(d7b.data)<-"y1"
d7b.data$logtime<-func$logtime
ggplot(aes(x=logtime, y=y1), data=d7b.data)+geom_point()+scale_x_continuous(breaks=c(0,10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120))

# Finding the values at which the second derivative=0
f=function(x) eval(d7b)
uniroot(f, c(0,125))

inflection<-polyroot(c((a2 *2), (a3 *3 * 2 ),(a4* 4 * 3 ), (a5 *5 * 4) , (a6 * 6 * 5 ), (a7 * 7 * 6 )))
inflec<-as.data.frame(inflection)


```

## On individual 87
```{r}

# Filtering for a single individuals to just see the fit
func<-ox3%>%
  filter(ind=="87")# %>%
  #group_by(logtime) %>%
  #filter(duplicated(logtime|n()==2))

#Trying different curves
fit2<-lm(oxymg~poly(logtime, 2, raw=TRUE), data=func)
fit3<-lm(oxymg~poly(logtime, 3, raw=TRUE), data=func)
fit4<-lm(oxymg~poly(logtime, 4, raw=TRUE), data=func)
fit5<-lm(oxymg~poly(logtime, 5, raw=TRUE), data=func)
fit6<-lm(oxymg~poly(logtime, 6, raw=TRUE), data=func)
fit7<-lm(oxymg~poly(logtime, 7, raw=TRUE), data=func)
fit8<-lm(oxymg~poly(logtime, 8, raw=TRUE), data=func)
fit9<-lm(oxymg~poly(logtime, 9, raw=TRUE), data=func)
fit10<-lm(oxymg~poly(logtime, 10, raw=TRUE), data=func)

# CReating a dataframe to build the prediction
logtime <- seq(1, 125, length=125)  

# Plotting each predicted function line to the real data
plot(func$logtime, func$oxymg, pch=19, xlab='Logtime', ylab='Oxygen(mg/l)')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='grey')
lines(logtime, predict(fit2, data.frame(x=logtime)), col='red')
lines(logtime, predict(fit3, data.frame(x=logtime)), col='purple')
lines(logtime, predict(fit4, data.frame(x=logtime)), col='blue')
lines(logtime, predict(fit5, data.frame(x=logtime)), col='orange')
lines(logtime, predict(fit6, data.frame(x=logtime)), col='green')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='grey')
lines(logtime, predict(fit8, data.frame(x=logtime)), col='yellow')
lines(logtime, predict(fit9, data.frame(x=logtime)), col='red')
lines(logtime, predict(fit10, data.frame(x=logtime)), col='grey')

#calculated adjusted R-squared of each model

# The adjusted r squared is the percent of the variance of Y intact after subtracting the error of the model. The more the R Squared value the better the model is for that data frame.
summary(fit2)$adj.r.squared
summary(fit3)$adj.r.squared
summary(fit4)$adj.r.squared
summary(fit5)$adj.r.squared
summary(fit6)$adj.r.squared
summary(fit7)$adj.r.squared
summary(fit8)$adj.r.squared
summary(fit9)$adj.r.squared
summary(fit10)$adj.r.squared

coef7<-as.data.frame(fit7$coefficients)
a0<-coef7[1,1]
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1] #cambiar a A
x<-func$logtime
form7<-expression((a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0))
d7<-D(form7, "x") 
d7b<-D(d7, "x")

ggplot(aes(x=logtime, y=oxymg), data=func)+geom_point()
plot(x, func$oxymg, pch=19, xlab='Logtime', ylab='Oxygen(mg)')
lines(logtime, predict(fit7, data.frame(x=logtime)), col='red')

#Primera derivada: tasa con la que consume oxigeno
d7b.data<-as.data.frame(eval(d7, envir=as.data.frame(x)))
colnames(d7b.data)<-"y1"
d7b.data$logtime<-func$logtime
ggplot(aes(x=logtime, y=y1), data=d7b.data)+geom_point()


#Segunda derivada: cruce con y=0 son los punto de cambio, puntos de inflexion donde la pendiente cambia hacia arriba o hacia abajo
d7b.data<-as.data.frame(eval(d7b, envir=as.data.frame(x)))
colnames(d7b.data)<-"y1"
d7b.data$logtime<-func$logtime
ggplot(aes(x=logtime, y=y1), data=d7b.data)+geom_point()+scale_x_continuous(breaks=c(0,10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120))

# Finding the values at which the second derivative=0
#f=function(x) eval(d7b)
#uniroot(f, c(0,125))

inflection<-polyroot(c((a2 *2), (a3 *3 * 2 ),(a4* 4 * 3 ), (a5 *5 * 4) , (a6 * 6 * 5 ), (a7 * 7 * 6 )))
inflection
inflec<-as.data.frame(inflection)
#inflec$inflection<-as.numeric*inflec$inflection

```




# Trimming traces with weird patterns

> Some traces have some weird drops/fluctuations of oxygen in the middle of the trace. In order to get a better idea of the general oxygen trace, John reccomended I cut those portions of the trace before fitting the polynomial function to the data.
> After cutting the traces, I removed the individuals from the original dataset and then add the new, trimmed traces. This created the file "oxall_trimmed.csv" 

## Calling the csv file of the oxygen calculations to avoid running the whole code above
```{r}
#Calling csv file to avoid running the whole code
oxall<-read.csv("./Outputs/oxygenall_aftercodedeletion.csv") #Use this one for trimming the traces, but for everything else use the one named: "oxall_trimmed.csv", which is the one produced at the end of this section of the code


```
## Individual 22
```{r}
ind22<-oxall %>%
filter(ind=="22")
ggplot(aes(x=logtime, y=oxymg), data=ind22)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind22<-ind22 %>%
filter(!between(logtime, 75, 85))
ggplot(aes(x=logtime, y=oxymg), data=ind22)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 83
```{r}
ind83<-oxall %>%
filter(ind=="83")
ggplot(aes(x=logtime, y=oxymg), data=ind83)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind83<-ind83 %>%
filter(!between(logtime, 70, 80))
ggplot(aes(x=logtime, y=oxymg), data=ind83)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 131
```{r}
ind131<-oxall %>%
filter(ind=="131")
ggplot(aes(x=logtime, y=oxymg), data=ind131)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind131<-ind131 %>%
filter(!between(logtime, 72, 82))
ggplot(aes(x=logtime, y=oxymg), data=ind131)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 136
```{r}
ind136<-oxall %>%
filter(ind=="136")
ggplot(aes(x=logtime, y=oxymg), data=ind136)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind136<-ind136 %>%
filter(!between(logtime, 72, 82))
ggplot(aes(x=logtime, y=oxymg), data=ind136)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 159
```{r}
ind159<-oxall %>%
filter(ind=="159")
ggplot(aes(x=logtime, y=oxymg), data=ind159)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind159<-ind159 %>%
filter(!between(logtime, 65, 75))
ggplot(aes(x=logtime, y=oxymg), data=ind159)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 168
```{r}
ind168<-oxall %>%
filter(ind=="168")
ggplot(aes(x=logtime, y=oxymg), data=ind168)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind168<-ind168 %>%
filter(!between(logtime, 75 ,90))
ggplot(aes(x=logtime, y=oxymg), data=ind168)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 267
```{r}
ind267<-oxall %>%
filter(ind=="267")
ggplot(aes(x=logtime, y=oxymg), data=ind267)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind267<-ind267 %>%
filter(!between(logtime, 80, 90))
ggplot(aes(x=logtime, y=oxymg), data=ind267)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Individual 270
```{r}
ind270<-oxall %>%
filter(ind=="270")
ggplot(aes(x=logtime, y=oxymg), data=ind270)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
ind270<-ind270 %>%
filter(!between(logtime, 70, 80))
ggplot(aes(x=logtime, y=oxymg), data=ind270)+geom_point() +theme_classic() + theme(text=element_text(size=15))+scale_x_continuous(breaks = seq(0, 120, by = 5))
```

## Creating new dataset with trimmed individuals
```{r}
oxall<-oxall%>%
filter(!ind%in%c("22","83", "131", "136", "159", "168", "267", "270")) %>%
bind_rows(ind22, ind83, ind131, ind136, ind159, ind168, ind267, ind270) %>% 
  filter_all(all_vars(!is.infinite(.)))
levels(as.factor(oxall$ind))
write.csv(oxall, "Outputs/oxall_trimmed.csv")
```





## Checking the oxygen traces per life stage 

> Plotting all the traces separated by life stage and colored by trial

### Protonymphs
```{r}
protos <- oxall%>%
  filter(stage=="Protonymph")
  
  
ggplot(protos, aes(x=logtime, y=oxymg,group=ind, color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  ylim(0.00010, 0.00015) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L")+
  ggtitle("Protonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="OxygenTrace_Protonymphs.jpg",  path="Outputs/Oxygen traces/")

  
```
### Deutonymphs
```{r}
deutos <- oxall%>%
  filter(stage=="Deutonymph")
  
  
ggplot(deutos, aes(x=logtime, y=oxymg,group=ind, color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  ylim(0.00010, 0.00015) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L")+
  ggtitle("Protonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="OxygenTrace_Deutonymphs.jpg",  path="Outputs/Oxygen traces/")

  
```
### Tritonymphs
```{r}
Tritos <- oxall%>%
  filter(stage=="Tritonymph")
  
  
ggplot(Tritos, aes(x=logtime, y=oxymg,group=ind, color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  ylim(0.00010, 0.00015) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L")+
  ggtitle("Tritonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="OxygenTrace_Tritonymphs.jpg",  path="Outputs/Oxygen traces/")

  
```
### Males
```{r}
males <- oxall%>%
  filter(stage=="Male")
  
  
ggplot(males, aes(x=logtime, y=oxymg,group=ind, color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  ylim(0.00010, 0.00015) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L")+
  ggtitle("Males")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="OxygenTrace_Males.jpg",  path="Outputs/Oxygen traces/")

  
```

### Females
```{r}
females <- oxall%>%
  filter(stage=="Female")
  
  
ggplot(females, aes(x=logtime, y=oxymg,group=ind, color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  ylim(0.00010, 0.00015) +
  facet_wrap(~ind)+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L")+
  ggtitle("Females")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="OxygenTrace_Females.jpg",  path="Outputs/Oxygen traces/")

  
```

# Creating a loops to fit polynomial functions for all individuals 

> The following code will do the following steps for each single individual: 
  1. Fit the polynomial function of 10 degrees to each individual and obtain the adjusted r-square to evaulate model fitting for each individual (file: modelfitting.csv)  
  2. Plot the oxygen trace and the polynomial function together (Plots in folder named "Function fit")  
  3. Get the first and second derivatives for all the traces (file: derivatives.csv)  
  4. Plot the first and second derivatives (in folders "First derivative plots"  and " Second derivative plots" respectively)  
  5. Obtaining the inflection points from the second derivative (file: inflections.csv)  
  6. Making combined figures by merging the traces with the function fitted, the first and second derivatives plots (in folder named "Figure montages")  

## Getting data for the loops
```{r}
oxall<-read.csv("Outputs/oxall_trimmed.csv") #Using the oxygen traces that were trimmed for some individuals that had weird patterns

# Creating separate lists, one for each individual
dat_list<-split(oxall, oxall$ind)
```

  

## 1. Adjusting a polynomial function to each individual

```{r}
# Creating function for fitting model
r2 = function(data) {
fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data) #fitting the model
output<-broom::glance(fit) #Getting adjusted r
suma<-broom::tidy(summary(fit)) #Getting parameters for model
merge(output, suma, all=TRUE) #merging both datasets into a single table
}
a<-map_dfr(dat_list, r2, .id = "id") #Provides dataframe with adjusted R
write.csv(a,"./Outputs/modelfitting.csv")

```

## 2. Plotting the function to the data of each individual

```{r}
# Creating plots to see the fit
r3 = function(data) {
     fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data) #fitting the model
     id<-data[1,12] #Getting ID for each individual
     
     mypath <- file.path("Outputs/Function fit/",paste("Individual_", id, ".jpg", sep = "")) #defining path and name for each individual


      jpeg(file = mypath, width=20, height=12, units="cm", res=300) 

        plot(data$logtime, data$oxymg, pch=19, xlab='Time (min)', ylab='Oxygen(mg)', main=paste("Function fit: Ind", id), cex.lab=1.5, cex.axis=1.25)
lines(data$logtime, predict(fit, data.frame(logtime=data$logtime)), col='red',lwd=2)
dev.off()
     }

map_dfr(dat_list, r3, .id = "id") #This applies the function for each table in the list. this works best for creating plots
```



## 3. Getting the first and second derivative for each individual

```{r}
# Getting the derivatives for each individual
#a2<-split(a, a$id)
r4=function(data){
fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data) #fitting the model
coef7<-as.data.frame(fit$coefficients) #Getting summary data into dataframe to extract each coefficient
a0<-coef7[1,1] #extracting each coefficient from the summary
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1]
a8<-coef7[9,1]
a9<-coef7[10,1]
a10<-coef7[11,1]
#x<-ox3$logtime #Values from raw data
x <- seq(0, 125, by=0.20) #Defining the sequence of logtime to use
form7<-expression((a10*x^10)+(a9*x^9)+(a8*x^8)+(a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0)) #Creating the formula of the polynomial function
d7<-D(form7, "x") #getting the first derivative
d7f.data<-as.data.frame(eval(d7, envir=as.data.frame(x))) #Saving output of the first derivative as a data frame
colnames(d7f.data)<-"y1" #defining column name for the first derivative dataframe
d7f.data$logtime<-x #Creating logtime column for first derivative dataframe
d7b<-D(d7, "x") #Getting the second derivative
d7s.data<-as.data.frame(eval(d7b, envir=as.data.frame(x))) #Saving output of the second derivative as a data frame
colnames(d7s.data)<-"y1" #defining column name for the second derivative dataframe
d7s.data$logtime<-x #Creating logtime column for second derivative dataframe
deriv<-list("first"=d7f.data, "second"=d7s.data) #Merging two dataframes together
}
a3<-map_dfr(dat_list, r4, .id = "id") #Creates the list with the values of the two derivatives

## Saving the second derivatives into a single dataframe
write.csv(a3, "./Outputs/derivatives.csv")

```

## 4. Plotting the first derivative
```{r}
# Plotting the first derivative

## See #3 above for the rest of the annotations. I will only annotate here what is different from above
r4first=function(data){
  fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data)
coef7<-as.data.frame(fit$coefficients)
a0<-coef7[1,1]
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1]
a8<-coef7[9,1]
a9<-coef7[10,1]
a10<-coef7[11,1]
id<-data[1,12]
  #x<-ox3$logtime #Values from raw data
x <- seq(0, 125, by=0.20) 
 form7<-expression((a10*x^10)+(a9*x^9)+(a8*x^8)+(a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0))
d7<-D(form7, "x") 
d7f.data<-as.data.frame(eval(d7, envir=as.data.frame(x)))
colnames(d7f.data)<-"y1"
d7f.data$logtime<-x

mypath <- file.path("Outputs/First derivative plots/",paste("Individual_", id, ".jpg", sep = "")) #creating name and path for the plot


 jpeg(file = mypath, width=20, height=12, units="cm", res=300) #opens file plot



plot(d7f.data$logtime, d7f.data$y1*-1, pch=19, xlab='Time (min)', ylab='Oxygen consumption rate (mg/min)', main=paste("First derivative: Ind ", id), cex.lab=1.5, cex.axis=1.25, ylim=c((-0.5*10^(-6)), (0.75*10^(-6)) )) #plotting the first derivative
dev.off()
}

map(dat_list, r4first) #created plot for each individual
```

## 5. Plotting the second derivative

```{r}
# Plotting the second derivative

#Annotations as the same as #3 and #4, the only difference is that this plot the data for the second derivative but the code is pretty much the same

r4second=function(data){
   fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data)
coef7<-as.data.frame(fit$coefficients)
a0<-coef7[1,1]
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1]
a8<-coef7[9,1]
a9<-coef7[10,1]
a10<-coef7[11,1]
id<-data[1,12]
  #x<-ox3$logtime #Values from raw data
  x <- seq(0, 125, by=0.20) 
   form7<-expression((a10*x^10)+(a9*x^9)+(a8*x^8)+(a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0))
d7<-D(form7, "x") 
d7b<-D(d7, "x")
d7s.data<-as.data.frame(eval(d7b, envir=as.data.frame(x)))
colnames(d7s.data)<-"y1"
d7s.data$logtime<-x

mypath <- file.path("Outputs/Second derivative plots/",paste("Individual_", id, ".jpg", sep = ""))


 jpeg(file = mypath, width=20, height=12, units="cm", res=300)
plot(d7s.data$logtime, d7s.data$y1, pch=19, xlab='Time (min)', ylab='Change oxygen cons. rate (mg/min)', main=paste("Second derivative: Ind", id), cex.lab=1.5, cex.axis=1.25, ylim=c((-0.75e-7),(0.75e-7))) #plots the second derivative
abline(h=0,col="orange", lty=2, lwd=2) #line to visualize the intersection with zero (relevant for the inflection points)
dev.off()
}

map(dat_list, r4second) #Plots the second derivative plots for each individual
```

## 6. Getting the inflection points

```{r}
# Getting the inflection points: the points where there was a change in the "slope"
## Procedure is pretty much the same as above, I will only comment what is different
r5=function(data){
  fit = lm(oxymg~poly(logtime, 10, raw=TRUE), data = data)
coef7<-as.data.frame(fit$coefficients)
a0<-coef7[1,1]
a1<-coef7[2,1]
a2<-coef7[3,1]
a3<-coef7[4,1]
a4<-coef7[5,1]
a5<-coef7[6,1]
a6<-coef7[7,1]
a7<-coef7[8,1]
a8<-coef7[9,1]
a9<-coef7[10,1]
a10<-coef7[11,1]
id<-data[1,12]
#x<-ox3$logtime #Values from raw data
x <- seq(0, 125, by=0.20)
form7<-expression((a10*x^10)+(a9*x^9)+(a8*x^8)+(a7*x^7)+(a6*x^6)+(a5*x^5)+(a4*x^4)+(a3*x^3)+(a2*x^2)+(a1*x^1)+(a0*x^0))
d7<-D(form7, "x")
d7b<-D(d7, "x")
inflection<-polyroot(c((a2 *2), (a3 *3 * 2 ),(a4* 4 * 3 ), (a5 *5 * 4) , (a6 * 6 * 5 ), (a7 * 7 * 6 ),(a8 *8*7), (a9*9*8), (a10*10*9))) #Estimates the inflection points from the coefficients above as well as the formula as established for a polynomial of 10 degrees
inflec<-as.data.frame(inflection) #Creates a dataframe of the inflection points
inflec$id<-data[1,1] #adds the id for each individual's inflection points
as.data.frame(inflec) #creates a dataframe with all the inflection points per individual
}
a4<-map_dfr(dat_list, r5, .id = "id") # List of dataframes containing the inflection points


## Merging points into a single dataframe
options(scipen=999) #Removing scientific notation
inflections<-a4%>%
bind_rows() %>%
mutate(real=Re(inflection), #Extracting the real number from the complex expression
values=format(real, scientific=FALSE, big.mark=","), #Coverting the real number to printed decimal expression
rounded=round(real, digits=2), #rounding the real number
imagine=round(Im(inflection), digits=2)) %>% #Extracting the imaginary number
filter(between(real, 10, 105)) #Filters out the inflections that occurred before 10 minutes and after 105 minutes, reducing it to the time where the ramping was programmed to occur
write.csv(inflections, "./Outputs/inflections.csv") #saves the file as a csv file
  

```


## 7. Making combined figures for the function fit, first and second derivatives

```{r}
# AS a function
make_grid <- function(id){
  #Establishing paths
  f1<-paste0("Outputs/Function fit/Individual_",id,".jpg") #oxygen trace with function
  f2<-paste0("Outputs/First derivative plots/","Individual_",id,".jpg") #first derivative
  f3<-paste0("Outputs/Second derivative plots/","Individual_",id,".jpg") #second derivative
  #Reading images
 j1<-readJPEG(f1) #oxygen trace with function
 j2<-readJPEG(f2) #first derivative
 j3<-readJPEG(f3) #second derivative
  #Establishing path
 mypath <- file.path("C:/Users/laus1/OneDrive - University of Nebraska-Lincoln/UNL/PhD Tesis/Methods/Thermolimit/Thermolimit data analyses/Outputs/Figure montages/", paste("Individual_", id, ".jpg", sep = ""))
# Creating figures
jpeg(file = mypath, width=20, height=36, units="cm", res=300) #created file for the image, with the measurements and resolution
par(mar=c(1,1,1,1)) #defining margin size
layout(matrix(1:3, ncol=1,byrow=TRUE)) #defining that the images will be arranged in 1 column with 3 rows, and will be filled by row
 plot(NA,xlim=0:1,ylim=0:1,xaxt="n",yaxt="n") #creates empty space for putting the following image
 rasterImage(j1,0,0,1,1) #adding the image of the oxygen trace
 plot(NA,xlim=0:1,ylim=0:1,xaxt="n",yaxt="n") #creates empty space for putting the following image
 rasterImage(j2, 0,0,1,1) #adding the image of the first derivative
 plot(NA,xlim=0:1,ylim=0:1,xaxt="n",yaxt="n") #creates empty spacefor putting the following image
rasterImage(j3, 0,0,1,1)#adding the image of the second derivative
dev.off() #Closes the figure
 
  }

groups<-levels(as.factor(a$id)) #created the list of ids based on the dataframe that was created in #1 above when fitting the function to the traces 

map(groups, make_grid) # creates all the figures for each individual 

```


# Estimating Ropt and Topt

## For all individuals
### Getting the maximum rate of oxygen consumption (Rate optima, Ropt)
> Once we have the derivatives and their respective plots, we can estimate the point in time where the rate of oxygen consumed was maximized (which represents the Rate optima, Ropt). As the first derivative represent the change in oxygen consumption over time, we can use the first derivative to get this. The maximum point in the trace of the first derivative is the Ropt. 

> The following code will call the file contining the values of the derivatives, will then conver the first derivative to positive values and cur the trace to focus on the time period where the ramping was actually occurring (between minutes 30 and 105). Then it will extract row where the maximum point is recorded for each individual. That file will then be used to also estimate the Thermal optima (next part)

> This first part of the code for Ropt and Topt will do the same procedure for all individuals, but as some have traces with patterns that differ a bit, some adjustments will be done afterwards.



```{r}
derivs<-read.csv("Outputs/derivatives.csv") #getting the derivative data


derivs<-derivs %>%
  mutate(first2=first.y1*-1)%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) #Triming the timeframe to the actual slope time
  
# Plotting to see if the conversion looks right
derivs%>%
  filter(id==10) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

derivs%>%
  filter(id==3) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

# Getting the row with the maximum value for each individual
ropt<-derivs %>%
     group_by(id) %>%
     slice(which.max(first2))%>% #selects the row where the amximum point is recorded for each individual
  mutate(logtime=first.logtime, #changes the names of logtime and individual to facilitate merging in the next steps
         ind=id)


```

### Getting the Temperature optima (Topt)

> Once we know the point in time where the rate was maximize (Ropt), we can look for the temperature associated to that point in time during each trial, for each individual. We can do this by merging the ropt dataframe with the dataframe containing the temperature at each point in time (oxall).

> Here we create the file "ToptandRopts.csv" with the Ropt and Top for all individuals estimated the same way. However, we still need to see if the data makes sense.

```{r}
#Merging the temperatures
topt<-difference_left_join(ropt,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13). Since the ropt value coms from the derivatives, and the derivatives were estimated based on a sequence of values created for them rather than the real logtime values, the logtime in both dataframes is not exactly the same and we have to use an approximation instead
  group_by(ind.x, logtime.x, first.y1, first2) %>% 
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup()


#getting the other demographic data
toptfinal<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp")) %>% #selecting the more relevant variables
  group_by(ind)%>% #Grouping by individual
  filter(row_number()==1) %>% #getting just the first row for each individual
  right_join(topt, by=c("ind"="ind.x")) %>% #mergint the dataframes
  rename(logtime=logtime.x, #renaming some variables for simplification
         tempcorr=tempcorr2,
         ropt1=first.y1, 
         ropt2=first2) %>%
  ungroup()%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male", "Female"))) #changing the order of the levels within the factor "stage" 

levels(toptfinal$stage)

#Visualizing the topt and Ropt

## Temperature optima
ggplot(toptfinal, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")

#Rate optima
ggplot(toptfinal, aes(x=stage, y=ropt2))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Maximum rate of oxygen consumption")

#Saving the file
write.csv(toptfinal, "Outputs/ToptandRopts.csv")
```
### Evaluating extreme points for topt and ropt

> This would help me see if there are any weird trends with the data. I dropped trial 2 because the ramping rate on it was lower than that of the other trials and was biasing the results 

```{r}
# Plot with prediction trends, standard error and data
dat<-read.csv("Outputs/ToptandRopts.csv")
dat<-dat%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male","Female" ))) %>%
  arrange(stage)
dat2<-dat%>%filter(trial!=2)

plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot

```

> Protonymphs and deutonymphs seems to have some extreme values (over 50 C or so). Looking at the trends of those individuals might help explain what is happening (e.g. if the ropt that was picked up was from the "dying' peak (the one that might be occuring after death) rather than the real Ropt peak)

### Checking the first derivative trend per life stage during ramping only

> To see if the Ropt and topt above were extracted from curves that looked ok, here we plot all the curves for just the period where the ramping happened. If any trace seem off, we can adjust the trimming for a better capture of the real ropt and topt. 

#### Merging the demographic data to the derivative data
```{r}

oxall<-read.csv("Outputs/oxall_trimmed.csv")
derivs<-read.csv("Outputs/derivatives.csv") #getting the derivative data


#Protonymphs
oxallp<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Protonymph")


ids<-levels(as.factor(oxallp$ind))
ids

derivsp2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsp<-difference_left_join(derivsp2,oxallp, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)
  




#Deutonymphs  
oxalld<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Deutonymph")

ids<-levels(as.factor(oxalld$ind))
ids

derivsd2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsd<-difference_left_join(derivsd2,oxalld, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)
  

#Tritonymphs  
oxallt<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Tritonymph")

ids<-levels(as.factor(oxallt$ind))
ids

derivst2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivst<-difference_left_join(derivst2,oxallt, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)


#Males 
oxallm<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Male")

ids<-levels(as.factor(oxallm$ind))
ids

derivsm2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsm<-difference_left_join(derivsm2,oxallm, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)

#Females 
oxallf<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Female")

ids<-levels(as.factor(oxallf$ind))
ids

derivsf2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsf<-difference_left_join(derivsf2,oxallf, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)


  
derivsdemography<- bind_rows(derivsp, derivsd, derivst, derivsm, derivsf)  
write.csv(derivsdemography, "Outputs/derivsdemography.csv")

derivs2<-read.csv("Outputs/derivsdemography.csv")
```

#### Plotting each derivative trace for each life stage
##### Protonymphs
```{r}
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
  
ggplot(protos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab("Oxygen(mg) /time (min)")+
  ggtitle("Protonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_Protonymphs.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```
##### Deutonymphs
```{r}
deutos <- derivs2%>%
  filter(stage=="Deutonymph")
  
  
ggplot(deutos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)/time (min)")+
  ggtitle("Deutonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsnTrace_Deutonymphs.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```
##### Tritonymphs
```{r}
Tritos <- derivs2%>%
  filter(stage=="Tritonymph")
  
  
ggplot(Tritos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)/time (min)")+
  ggtitle("Tritonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_Tritonymphs.jpg",  path="Outputs/Derivative traces per stage/", width=7, height=7, units="in")

  
```

##### Males
```{r}
males <- derivs2%>%
  filter(stage=="Male")
  
  
ggplot(males, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg)/time (min)")+
  ggtitle("Males")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_Males.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```

##### Females
```{r}
females <- derivs2%>%
  filter(stage=="Female")
  
  
ggplot(females, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab("Oxygen (mg/L)/time (min)")+
  ggtitle("Females")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_Females.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```




> I made a power point presentation to compare the peaks of the individuals with the high values to those who had a more "normal" pattern.  I decided to manually select the curves for those individuals whose Ropt might be reflecting the "dying" peak instead of the "real" ropt peak.


## Manually trimming the first derivative for those individuals whose ropt values are on the "dying" peak
### Trimming for selected individuals
```{r}
derivs<-read.csv("Outputs/derivatives.csv") #getting the derivative data

derivs<-derivs %>%
  mutate(first2=first.y1*-1)%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105))

#Cutting the trace for the individuals with an ropt of the dying peak
## Protonymphs
derivstrim<-derivs%>%
  filter(id=="36") %>% #filtering to each individual
  filter(between(first.logtime, 50, 85)) 

# Not in "dying peak, but maybe in the "adjusting" peak? (the first peak where temperatures are adjusting af the begining of the ramp)
indiv<-derivs%>%
  filter(id=="35") %>% #filtering to each individual
  filter(between(first.logtime, 60, 95)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


indiv<-derivs%>%
  filter(id=="43") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="154") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="165") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="294") %>% #filtering to each individual
  filter(between(first.logtime, 50, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="301") %>% #filtering to each individual
  filter(between(first.logtime, 60, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="324") %>% #filtering to each individual
  filter(between(first.logtime, 30, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="337") %>% #filtering to each individual
  filter(between(first.logtime, 30, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


##Deutonymphs
indiv<-derivs%>%
  filter(id=="22") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="136") %>% #filtering to each individual
  filter(between(first.logtime, 50, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


indiv<-derivs%>%
  filter(id=="171") %>% #filtering to each individual
  filter(between(first.logtime, 40, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="213") %>% #filtering to each individual
  filter(between(first.logtime, 30, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="270") %>% #filtering to each individual
  filter(between(first.logtime, 30, 100)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="274") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="288") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="300") %>% #filtering to each individual
  filter(between(first.logtime, 40, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="314") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

#Tritonymphs
indiv<-derivs%>%
  filter(id=="239") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="345") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

#Males
indiv<-derivs%>%
  filter(id=="168") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


```

### Merging selected individuals to the rest of the data

> Here, from the original file with the derivative traces, I remove the individuals whose traces where manually cut. Then I add the the new trimmed traces to the same file and save it as its own csv file (derivs_manualtrimforsome.csv)

```{r}
ids<-levels(as.factor(derivstrim$id))
ids<-as.numeric(ids)
ids

derivstrim2<-derivs%>%
filter(!id%in%ids) %>% #removing individuals that got redone
bind_rows(derivstrim) 

ids<-levels(as.factor(derivstrim2$id))
ids<-as.numeric(ids)
ids

write.csv(derivstrim2, "Outputs/derivs_manualtrimforsome.csv")
```


### Checking the first derivative trend per life stage during ramping only 

> To see if the trimming looked better, we now plot again each curve separated by life stage and colored by trial. 

#### Merging the demographic data to the derivative data
```{r}

oxall<-read.csv("Outputs/oxall_trimmed.csv")
derivs<-read.csv("Outputs/derivs_manualtrimforsome.csv") #getting the derivative data


#Protonymphs
oxallp<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime", "tempcorr")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Protonymph")


ids<-levels(as.factor(oxallp$ind))
ids

derivsp2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsp<-difference_left_join(derivsp2,oxallp, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)
  




#Deutonymphs  
oxalld<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime", "tempcorr")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Deutonymph")

ids<-levels(as.factor(oxalld$ind))
ids

derivsd2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsd<-difference_left_join(derivsd2,oxalld, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)
  

#Tritonymphs  
oxallt<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime", "tempcorr")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Tritonymph")

ids<-levels(as.factor(oxallt$ind))
ids

derivst2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivst<-difference_left_join(derivst2,oxallt, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)


#Males 
oxallm<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime", "tempcorr")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Male")

ids<-levels(as.factor(oxallm$ind))
ids

derivsm2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsm<-difference_left_join(derivsm2,oxallm, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)

#Females 
oxallf<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp", "logtime", "tempcorr")) %>%
  mutate(id=ind,
         first.logtime=logtime)%>% 
  filter(between(logtime, 30, 105)) %>%
  filter(stage=="Female")

ids<-levels(as.factor(oxallf$ind))
ids

derivsf2<-derivs %>%
  mutate(first2=first.y1*-1, 
         ind=as.factor(id))%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) %>% #Triming the timeframe to the actual slope time
  filter(ind %in% ids)

#Merging the temperatures
derivsf<-difference_left_join(derivsf2,oxallf, by=c("id","first.logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)


  
derivsdemography<- bind_rows(derivsp, derivsd, derivst, derivsm, derivsf)  
write.csv(derivsdemography, "Outputs/derivsdemography_manualtrim.csv")

derivs2<-read.csv("Outputs/derivsdemography_manualtrim.csv")
```

#### Plotting each derivative trace for each life stage
##### Protonymphs
```{r}
protos <- derivs2%>%
  filter(stage=="Protonymph")
  
  
ggplot(protos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab(bquote(VO[2]~(mgO[2]~min^-1)))+
  ggtitle("Protonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_ProtonymphsTrim.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```
##### Deutonymphs
```{r}
deutos <- derivs2%>%
  filter(stage=="Deutonymph")
  
  
ggplot(deutos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
 ylab(bquote(VO[2]~(mgO[2]~min^-1)))+
  ggtitle("Deutonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsnTrace_DeutonymphsTrim.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```
##### Tritonymphs
```{r}
Tritos <- derivs2%>%
  filter(stage=="Tritonymph")
  
  
ggplot(Tritos, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab(bquote(VO[2]~(mgO[2]~min^-1)))+
  ggtitle("Tritonymphs")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_TritonymphsTrim.jpg",  path="Outputs/Derivative traces per stage/", width=7, height=7, units="in")

  
```

##### Males
```{r}
males <- derivs2%>%
  filter(stage=="Male")
  
  
ggplot(males, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
  ylab(bquote(VO[2]~(mgO[2]~min^-1)))+
  ggtitle("Males")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_MalesTrim.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```

##### Females
```{r}
females <- derivs2%>%
  filter(stage=="Female")
  
  
ggplot(females, aes(x=logtime, y=first2,color=as.factor(trial)))+ #MODIFY FOR EACH TRIAL
  geom_line()+
  facet_wrap(~ind.x)+
  theme_classic()+
  theme(text = element_text(size = 15), plot.title = element_text(size = (12)))+
  xlab("Time logged (min)")+
 ylab(bquote(VO[2]~(mgO[2]~min^-1)))+
  ggtitle("Females")+
  labs(colour = "Trial")

ggsave(plot=last_plot(),filename="DerivsTrace_FemalesTrim.jpg",  path="Outputs/Derivative traces per stage/",width=7, height=7, units="in")

  
```




### Getting the maximum rate of oxygen consumption (Rate optima, Ropt) 
> As we did before, we can now estimate the point in time where the rate of oxygen consumed was maximized (which represents the Rate optima, Ropt) for the newly trimmed traces. 


```{r}
derivs<-read.csv("Outputs/derivs_manualtrimforsome.csv") #getting the derivative data


derivs<-derivs %>%
  mutate(first2=first.y1*-1)%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105)) #Triming the timeframe to the actual slope time
  
# Plotting to see if the conversion looks right
derivs%>%
  filter(id==10) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

derivs%>%
  filter(id==300) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

# Getting the row with the maximum value for each individual
ropt<-derivs %>%
     group_by(id) %>%
     slice(which.max(first2))%>% #selects the row where the amximum point is recorded for each individual
  mutate(logtime=first.logtime, #changes the names of logtime and individual to facilitate merging in the next steps
         ind=id)


```

### Getting the Temperature optima (Topt)

> Once we know the point in time where the rate was maximize (Ropt), we can look for the temperature associated to that point in time during each trial, for each individual. We can do this by merging the ropt dataframe with the dataframe containing the temperature at each point in time (oxall).

> Here we create the file "ToptandRopts_trim.csv" with the Ropt and Top for all individuals estimated the same way. However, we still need to see if the data makes sense.

```{r}
#Merging the temperatures
topt<-difference_left_join(ropt,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13). Since the ropt value coms from the derivatives, and the derivatives were estimated based on a sequence of values created for them rather than the real logtime values, the logtime in both dataframes is not exactly the same and we have to use an approximation instead
  group_by(ind.x, logtime.x, first.y1, first2) %>% 
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup()


#getting the other demographic data
toptfinal<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp")) %>% #selecting the more relevant variables
  group_by(ind)%>% #Grouping by individual
  filter(row_number()==1) %>% #getting just the first row for each individual
  right_join(topt, by=c("ind"="ind.x")) %>% #mergint the dataframes
  rename(logtime=logtime.x, #renaming some variables for simplification
         tempcorr=tempcorr2,
         ropt1=first.y1, 
         ropt2=first2) %>%
  ungroup()%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male", "Female"))) #changing the order of the levels within the factor "stage" 

levels(toptfinal$stage)

#Visualizing the topt and Ropt

## Temperature optima
ggplot(toptfinal, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")

#Rate optima
ggplot(toptfinal, aes(x=stage, y=ropt2))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Maximum rate of oxygen consumption")

#Saving the file
write.csv(toptfinal, "Outputs/ToptandRopts_trim.csv")
```
### Evaluating extreme points for topt and ropt

> This would help me see if there are any weird trends with the data. I dropped trial 2 because the ramping rate on it was lower than that of the other trials and was biasing the results 

```{r}
# Plot with prediction trends, standard error and data
dat<-read.csv("Outputs/ToptandRopts_trim.csv")
dat<-dat%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male","Female" ))) %>%
  arrange(stage)
dat2<-dat%>%filter(trial!=2)

plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot

# Plotting with averages
averages<-dat2%>%
  group_by(stage) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat2, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) + 
  theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot


## Checking outliers
ggplot(dat2, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")


#Taking out possible outliers (based on boxplot)
#dat3<-dat2 %>%
#  filter(!ind %in% c(35,32,173,141,270))

dat3<-dat2 %>%
  filter(!ind %in% c(270, 239, 173,141,35))


# Plotting with averages
averages<-dat3%>%
  group_by(stage) %>%
  summarize(mean=mean(tempcorr), sd=sd(tempcorr), n=n(), sem=sd/sqrt(n))
averages

averages$lwr3 <- with(averages, mean -  sem) #Using just the standard error
averages$upr3 <- with(averages, mean + sem)


# Plot with prediction trends, standard error and data
plot<-ggplot(dat3, aes(x = stage))+ 
  geom_point(aes(y = tempcorr, color=stage), size = 3, shape=1, stroke=1.2)  + 
  geom_point(aes(y = mean, color=stage),color = "black", size = 3, data = averages, position=position_nudge(x=0.1)) + 
  geom_errorbar(aes(x=stage, ymin = lwr3, ymax = upr3, group=stage), color = "black", data = averages, inherit.aes = FALSE, position=position_nudge(x=0.1), width=0.2) +   theme_classic()+ theme(text = element_text(size = 15))+ 
  xlab("Stage")+
  ylab("Thermal optima (Celsius)")
plot


## Checking outliers
ggplot(dat3, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")
```

### Comparing the Ropt with the inflection points

> To see how close we got the point from the original dataset of the second derivative.

```{r}
inflec<-read.csv("Outputs/inflections.csv")

inflec2<-inflec %>%
  select(id, real, values, rounded) %>%
  rename(ind=id, 
         logtime=real)

dat<-read.csv("Outputs/ToptandRopts_trim.csv")

derivsinf<-difference_left_join(dat,inflec2, by=c("ind","logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)

derivsinf<-derivsinf %>%
  mutate(diff=round(logtime.x-logtime.y, digits=3))

```
> All the Ropts chose where indeed, very close (less than 0.1 difference) to an inflection point



# Getting the activation energy
> The activation energy is how much energy it took the inviduals to reach the Ropt. We can get it by following the procedure described by Brown et al. (2004), which is a modification of the Arrhenius equation. 

For this I need to do the following to each individual:
1. Trim the first derivative from the closests left-sided minimum to the maximum value
2. Join the logtime from the trimmed derivative in 1, to the portion of temps associated on oxall
3. convert the temps to Kelvin, multiply it by the Boltzmann constant and convert it to electron voltz. Then do the inversion(1/x)
4. Log transform (ln) the derivate 
5. Get the slope of 4 as predicted by 3 (ln(deriv)~temperature)
6. Save such slope in a dataframe
7. Put everything in a single dataframe
8. Associate demographic data to each id

## Trimming the first derivative for each individual
> Here, I manually select the first part of the slope that leads to the Ropt, just to get some range closer for the final function below

```{r}
# Creating dataframe of manually cropped trends first
derivs<-read.csv("Outputs/derivs_manualtrimforsome.csv") #getting the derivative data


derivs<-derivs %>%
  mutate(first2=first.y1*-1)%>% #Converting the slopes to positive
  filter(between(first.logtime, 30, 105))

## Trim the first derivative from the closests left-sided minimum to the maximum value

derivstrim<-derivs%>%
  filter(id=="2") %>% #filtering to each individual
  filter(between(first.logtime, 35, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)

indiv<-derivs%>%
  filter(id=="3") %>% #filtering to each individual
  filter(between(first.logtime, 35, 66)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="4") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="5") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="7") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="10") %>% #filtering to each individual
  filter(between(first.logtime, 35, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="14") %>% #filtering to each individual
  filter(between(first.logtime, 35, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="18") %>% #filtering to each individual
  filter(between(first.logtime, 35, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="22") %>% #filtering to each individual
  filter(between(first.logtime, 40, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="24") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="28") %>% #filtering to each individual
  filter(between(first.logtime, 40, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="29") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="30") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="32") %>% #filtering to each individual
  filter(between(first.logtime, 20, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="35") %>% #filtering to each individual
  filter(between(first.logtime, 60, 82)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="36") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="37") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

#Changed
indiv<-derivs%>%
  filter(id=="43") %>% #filtering to each individual
  filter(between(first.logtime, 30, 55)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="48") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="50") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="54") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="57") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="66") %>% #filtering to each individual
  filter(between(first.logtime, 50, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="73") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="79") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="80") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="83") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="85") %>% #filtering to each individual
  filter(between(first.logtime, 30, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="87") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="107") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="109") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="112") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="113") %>% #filtering to each individual
  filter(between(first.logtime, 45, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="131") %>% #filtering to each individual
  filter(between(first.logtime, 30, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="136") %>% #filtering to each individual
  filter(between(first.logtime, 50, 74)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="138") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="143") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="145") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="146") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="153") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

#Changed
indiv<-derivs%>%
  filter(id=="154") %>% #filtering to each individual
  filter(between(first.logtime, 30,65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="156") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="158") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="159") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="165") %>% #filtering to each individual
  filter(between(first.logtime, 30, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="166") %>% #filtering to each individual
  filter(between(first.logtime, 35, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="168") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="171") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="175") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="179") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="194") %>% #filtering to each individual
  filter(between(first.logtime, 50, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="201") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="211") %>% #filtering to each individual
  filter(between(first.logtime, 35, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="212") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="214") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="216") %>% #filtering to each individual
  filter(between(first.logtime, 30, 60)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="218") %>% #filtering to each individual
  filter(between(first.logtime, 20, 81)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="224") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="228") %>% #filtering to each individual
  filter(between(first.logtime, 60, 81)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="232") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="233") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="237") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="238") %>% #filtering to each individual
  filter(between(first.logtime, 20, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="239") %>% #filtering to each individual
  filter(between(first.logtime, 30, 60)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="242") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="244") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="245") %>% #filtering to each individual
  filter(between(first.logtime, 20, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="246") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="247") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="248") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="250") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="251") %>% #filtering to each individual
  filter(between(first.logtime, 40, 60)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="253") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="256") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="257") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="258") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="263") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="264") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="267") %>% #filtering to each individual
  filter(between(first.logtime, 40, 72)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="269") %>% #filtering to each individual
  filter(between(first.logtime, 50, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="270") %>% #filtering to each individual
  filter(between(first.logtime, 45, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="271") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="272") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="274") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="287") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="288") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="290") %>% #filtering to each individual
  filter(between(first.logtime, 35, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="294") %>% #filtering to each individual
  filter(between(first.logtime, 50, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="296") %>% #filtering to each individual
  filter(between(first.logtime, 40, 72)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="298") %>% #filtering to each individual
  filter(between(first.logtime, 40, 72)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="300") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


indiv<-derivs%>%
  filter(id=="305") %>% #filtering to each individual
  filter(between(first.logtime, 60, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


indiv<-derivs%>%
  filter(id=="311") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="314") %>% #filtering to each individual
  filter(between(first.logtime, 30, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="317") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="322") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="324") %>% #filtering to each individual
  filter(between(first.logtime, 30, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="326") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="329") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="334") %>% #filtering to each individual
  filter(between(first.logtime, 60, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="335") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="337") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="339") %>% #filtering to each individual
  filter(between(first.logtime, 40, 73)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="341") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="345") %>% #filtering to each individual
  filter(between(first.logtime, 50, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

###

#indiv<-derivs%>%
#  filter(id=="51") %>% #filtering to each individual
#  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
#derivstrim<- bind_rows(derivstrim, indiv)

#indiv<-derivs%>%
#  filter(id=="141") %>% #filtering to each individual
#  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
#derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="173") %>% #filtering to each individual
  filter(between(first.logtime, 20, 60)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)

indiv<-derivs%>%
  filter(id=="213") %>% #filtering to each individual
  filter(between(first.logtime, 30, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)  

indiv<-derivs%>%
  filter(id=="301") %>% #filtering to each individual
  filter(between(first.logtime, 60, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
derivstrim<- bind_rows(derivstrim, indiv)


write.csv(derivstrim, "Outputs/derivsmanualtrimforenergy.csv")
```


## Creating the functions to get the activation energy for each individual
> After trimming the traces, now I can run the following code. There are two functions: one that creates the plots to look at the line whose slope represents the activation energy, and another to store the value of such slope into a dataframe. Both functions follow similar steps. They start by identifying the maximum and minimum points in the trace, then it trims the trace even more by using the min and maximum values as cut-off points. For the function that creates the plots, it does two plots at once: one plot is just to see what the final trimmed trace looks like, and the second one plots the line for the activation energy. To get the data for the second plot, I joined data from the oxall dataframe which had the temperature information, then converted the temperature to kelvin, mutiplied it by the Boltzmann constant, converted it to electron voltz and took the inversion (1/x) of that. Then estimated the linear model of that variable as the predictor for the log-transformed (natural log) first derivative values, , and use the slope and intercept values of that model to plot the line against the raw values. The other function does the last few steps (no plots), and stores the slope value, as well as the minimum and maximum values that were used to trim the trace. 

```{r}
# Creating separate lists, one for each individual
oxall<-read.csv("Outputs/oxall_trimmed.csv")
derivstrim<-read.csv("Outputs/derivsmanualtrimforenergy.csv")
dat_list<-split(derivstrim, derivstrim$id)

#Creating plots for al individuals
energy<-data.frame(matrix(ncol = 4, nrow = 0))
colnames(energy)<-c("ind", "slope", "min", "max")

e2 = function(data) {
     min<-data %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
     max<-data %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
data2<-data %>% filter(between(first.logtime, min[1,1], max[1,1]))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
#plotting trim deriv
ind<-data[2,4]
label<-paste("Individual ", ind, sep = "")
data2 %>%  ggplot(aes(x=logtime, y=first2))+geom_line() + theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+ xlab("Time (min)")+  ylab("Slope (first derivative)")  #Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/First deriv trim/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

## 2, 3, 4: Join data, kelvin and log transformations
data3<-difference_left_join(data2,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         invtemp=1/(tempk*((1.380649)*(10^-23))*(6.242*(10^18))), #inverting the  temp  (Kelvin) multiplied by the Boltzmann's constant (J/K), and then converting it from Joules into electron volts (1 J= 6.242X10^18)
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invtemp, data=data3)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
data3 %>%  ggplot(aes(x=invtemp, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="#810f7c", 
               linetype="solid", size=1.5) + ylim(-16.2,-14.5)+ 
  theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("Temperature(1/kT)")+
  ylab("ln(oxygen consumed, VO2)") #+ #Plotting to see what the line looks like
  #scale_x_continuous(labels=function(n){format(n, scientific=TRUE)})
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath, width=17, height=10, units="cm")
     }

map(dat_list, e2)


# Creating dataframe with the activation energy
e3 = function(data) {
     min<-data %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
     max<-data %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
data2<-data %>% filter(between(first.logtime, min[1,1], max[1,1]))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
data2 %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
data3<-difference_left_join(data2,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         invtemp=1/(tempk*((1.380649)*(10^-23))*(6.242*(10^18))), #inverting the  temp  (Kelvin) multiplied by the Boltzmann's constant (J/K), and then converting it from Joules into electron volts (1 J= 6.242X10^18)
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invtemp, data=data3)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-data[2,4]
dataframe<-data.frame(ind, slope, min[1,1], max[1,1])
#energy2<- bind_rows(energy2, dataframe)
     }

energy<-map_dfr(dat_list, e3, .id = "id")
colnames(energy)<-c("id", "ind", "slope", "min", "max")



write.csv(energy,"Outputs/activation energy.csv")




```

## Adding the demographic data
```{r}
# At the end: adding demographic data (pending modification)
#getting the other demographic data

energyfinal<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp")) %>%
  group_by(ind)%>%
  filter(row_number()==1) %>%
  right_join(energy, by=c("ind"="ind")) %>%
   ungroup()%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph", "Female", "Male" ))) %>%
  arrange(stage)
levels(energyfinal$stage)

write.csv(energyfinal, "Outputs/activation energy final.csv")
#date, time, datetime, channel, stage, weight, ramp
  
```

## Assessing the activation energy data

> Evaluating if there are any particular outliers and the general values at which the activation energy ranges for each life stage

```{r}
## Temperature optima
ggplot(energyfinal, aes(x=stage, y=slope))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Activation energy") # Check what units this would be


```

## Comparing max of activation energy with those of the Ropt
```{r}
energyfinal<-read.csv("Outputs/activation energy final.csv")

energyfinal<-energyfinal%>%
  mutate(logtime=max)

dat<-read.csv("Outputs/ToptandRopts_trim.csv")


energycheck<-difference_left_join(energyfinal,dat, by=c("ind", "logtime"), max_dist=0.13) #Merges dataframes based on the closest logtime value (within 0.13)

energycheck<-energycheck %>%
  mutate(diff=round(logtime.x-logtime.y, digits=3))
```





# Old code

# Estimating Topt and Ropt from the manual trim trend for those nymphs with very high topts

```{r}
# Calling the file that was created in code chunk 49 (manually trimming before the activation curves)

derivstrim<-read.csv("Outputs/derivsmanualtrim.csv")

#Individuals to redo
ids<-c(165,301,36,337,324,154,43,288,274,171,314,300,213,22,270,345,239,168)


derivst<-derivstrim %>%
  #filter(id %in% ids) %>%
  mutate(first2=first.y1*-1)


```

## Getting Ropt for the selected individuals
```{r}

# Plotting to see if the conversion looks right
derivst%>%
  filter(id==165) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

derivst%>%
  filter(id==301) %>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()

derivst%>%
  ggplot(aes(x=first.logtime, y=first2))+geom_line()+facet_wrap(~id)


# Getting the row with the maximum value for each individual
ropt<-derivst %>%
     group_by(id) %>%
     slice(which.max(first2))%>%
  mutate(logtime=first.logtime,
         ind=id)


```

## Getting the temperatures associated with the Ropt (Topt)
```{r}
oxall<-read.csv("./Outputs/oxygenall_aftercodedeletion.csv") #Use this one

#Merging the temperatures
topt<-difference_left_join(ropt,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup()


#getting the other demographic data
toptfinal_selected<-oxall %>%
  select(c("date", "trial", "channel", "ind", "stage", "weight", "ramp"))%>%
  #filter(ind %in% ids) %>%
  group_by(ind)%>%
  filter(row_number()==1) %>%
  right_join(topt, by=c("ind"="ind.x")) %>%
  rename(logtime=logtime.x,
         tempcorr=tempcorr2,
         ropt1=first.y1, 
         ropt2=first2) %>%
  ungroup()%>%
  mutate(stage=fct_relevel(stage, levels=c("Protonymph", "Deutonymph", "Tritonymph",  "Male", "Female" )))

levels(toptfinal_selected$stage)
#Visualizing the topt and Ropt

## Temperature optima
ggplot(toptfinal_selected, aes(x=stage, y=tempcorr))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Ctmax (Celsius)")

ggplot(toptfinal_selected, aes(x=stage, y=ropt2))+geom_boxplot() +theme_classic() + 
  theme(text = element_text(size = 15))+
  xlab("Stage")+
  ylab("Maximum rate of oxygen consumption")


write.csv(toptfinal, "Outputs/ToptandRopts.csv")
```



## Replacing old values for selected individuals
```{r}
dat<-read.csv("Outputs/ToptandRopts.csv")

topt2<-dat%>%
filter(!ind%in%ids) %>% #removing individuals that got redone
bind_rows(toptfinal_selected) %>% 
  filter_all(all_vars(!is.infinite(.)))
levels(as.factor(oxall$ind))


write.csv(topt2, "Outputs/ToptandRopts_manualtrimforsome.csv")
```





#############################################################################################

# Activation energy First try: one by one, ignore this one
```{r, eval=FALSE}
#Ind 2
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="2") %>% #filtering to each individual
  filter(between(first.logtime, 35, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
        #tempboltz=tempk*((1.380649)*(10^-23)), #Mutliplying temperatute in Kelvin by the Boltzmann constant
         invtemp=1/(tempk*((1.380649)*(10^-23))), #inverting the  temp in Kelvin multiplied by the Boltzmann's constant
         lnderiv=log(first2)) #Getting the natural log of the derivative values

## 5: Getting the slope
model<-lm(lnderiv~invtemp, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-2
energy<-data.frame(ind, slope,min,max)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invtemp, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)") +#Plotting to see what the line looks like
  scale_x_continuous(labels=function(n){format(n, scientific=TRUE)})

name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)
```


```{r, eval=FALSE}
#Ind 3
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="3") %>% #filtering to each individual
  filter(between(first.logtime, 35, 65)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-3
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 4
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="4") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-4
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 5
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="5") %>% #filtering to each individual
  filter(between(first.logtime, 40, 75)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-5
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 7
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="7") %>% #filtering to each individual
  filter(between(first.logtime, 50, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-7
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 10
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="10") %>% #filtering to each individual
  filter(between(first.logtime, 35, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-10
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 14
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="14") %>% #filtering to each individual
  filter(between(first.logtime, 35, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-14
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 18
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="18") %>% #filtering to each individual
  filter(between(first.logtime, 35, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-18
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 22
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="22") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-22
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 24
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="24") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-24
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 28
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="28") %>% #filtering to each individual
  filter(between(first.logtime, 40, 90)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-28
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 30
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="30") %>% #filtering to each individual
  filter(between(first.logtime, 40, 80)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-30
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

#Ind 29
## 1. Trim the first derivative from the closests left-sided minimum to the maximum value
indiv<-derivs%>%
  filter(id=="29") %>% #filtering to each individual
  filter(between(first.logtime, 40, 70)) # %>% #Triming the timeframe to the approximate relevant times (based on plot)
indiv %>%  ggplot(aes(x=first.logtime, y=first2))+geom_line() #Plotting to see what the line looks like
min<-indiv %>% slice(which.min(first2)) %>% select(first.logtime) #Getting the time where the minimum value is at
max<-indiv %>% slice(which.max(first2)) %>% select(first.logtime) #Getting the time where the maximum value is at
indiv<-indiv %>% filter(between(first.logtime, min, max))%>% #cutting the data to the max and minimum value
 mutate(logtime=first.logtime, ind=id) #changing variable names to facilitate merging later
indiv %>%  ggplot(aes(x=logtime, y=first2))+geom_line() #Plotting to see what the line looks like
## 2, 3, 4: Join data, kelvinf and log transformations
indiv<-difference_left_join(indiv,oxall, by=c("ind","logtime"), max_dist=0.13) %>% #Merges dataframes based on the closest logtime value (within 0.13)
  group_by(ind.x, logtime.x, first.y1, first2) %>%
  summarize(tempcorr2=mean(tempcorr)) %>% #averaging the tempcorr for when multiple cells are called
  ungroup() %>%
  mutate(tempk=tempcorr2+273.15, #converting temps to Kelvin
         lntempk=log(tempk), #converting kelvin to natural logarithm
         invlntempk=1/lntempk, #inverting the natural log of temp in K 
         lnderiv=log(first2)) #Getting the natural log of the derivative values
## 5: Getting the slope
model<-lm(lnderiv~invlntempk, data=indiv)
summary(model)
slope<-model$coefficients[2]
intercept<-model$coefficients[1]
## 6,7. Creating dataframe for the slope
ind<-29
dataframe<-data.frame(ind, slope)
energy<- bind_rows(energy, dataframe)
label<-paste("Individual ", ind, sep = "")
indiv %>%  ggplot(aes(x=invlntempk, y=lnderiv))+geom_point()+geom_abline(intercept = intercept, slope = slope, color="red", 
               linetype="solid", size=1.5) + ylim(-5,-3)+ theme_classic()+ theme(text = element_text(size = 15),plot.title = element_text(hjust=0.5))+ ggtitle(label)+
  xlab("1/lnTemp (K)")+
  ylab("ln(First derivative)")#Plotting to see what the line looks like
name<-paste("Individual_", ind, ".jpg", sep = "")
mypath <- file.path("Outputs/Activation energy plots/")
ggsave(plot=last_plot(),filename=name,  path=mypath)

```







Convert temperature to Kelvin
Cut all races t


plot1<-ggplot(data1,aes(x=logtime, y=oxymg)+geom_point( pch=19)+ xlab('Logtime')+ ylab('Oxygen(mg/l)')+main(paste("Individual ", id)) +theme_classic()+theme(size=18)
lines(data$logtime, predict(fit, data.frame(logtime=data$logtime)), col='red',lwd=1.2)



revisaar si el numero imaginario no tiene un valor despreciable y no esta replicado, ahi si es de cuidado
